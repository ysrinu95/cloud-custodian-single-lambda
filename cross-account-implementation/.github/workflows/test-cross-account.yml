name: Test Cross-Account Remediation

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        type: choice
        options:
          - event-forwarding
          - ec2-remediation
          - s3-remediation
          - all
      member_account_id:
        description: 'Member Account ID'
        required: true
        type: string

env:
  AWS_REGION: us-east-1

jobs:
  test-event-forwarding:
    name: Test Event Forwarding
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_type == 'event-forwarding' || 
      github.event.inputs.test_type == 'all'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (Member Account)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ github.event.inputs.member_account_id }}:role/OrganizationAccountAccessRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Send test event from member account
        run: |
          echo "Sending test CloudTrail event from member account..."
          
          aws events put-events --entries '[
            {
              "Source": "aws.cloudtrail",
              "DetailType": "AWS API Call via CloudTrail",
              "Detail": "{\"eventName\":\"RunInstances\",\"awsRegion\":\"us-east-1\",\"userIdentity\":{\"accountId\":\"${{ github.event.inputs.member_account_id }}\"}}"
            }
          ]'
          
          echo "✅ Test event sent from member account"

      - name: Configure AWS credentials (Central Account)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Wait for event processing
        run: sleep 30

      - name: Check Lambda logs in central account
        run: |
          echo "Checking Lambda execution logs in central account..."
          
          aws logs tail /aws/lambda/cloud-custodian-cross-account-executor \
            --since 2m \
            --format short
          
          echo "✅ Check logs above for event processing"

  test-ec2-remediation:
    name: Test EC2 Remediation
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_type == 'ec2-remediation' || 
      github.event.inputs.test_type == 'all'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (Member Account)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ github.event.inputs.member_account_id }}:role/OrganizationAccountAccessRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Create EC2 instance with public IP
        id: create-instance
        run: |
          echo "Creating test EC2 instance with public IP..."
          
          # Get default VPC
          VPC_ID=$(aws ec2 describe-vpcs --filters "Name=isDefault,Values=true" --query "Vpcs[0].VpcId" --output text)
          
          # Get first subnet
          SUBNET_ID=$(aws ec2 describe-subnets --filters "Name=vpc-id,Values=$VPC_ID" --query "Subnets[0].SubnetId" --output text)
          
          # Launch instance
          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2 \
            --instance-type t2.micro \
            --subnet-id $SUBNET_ID \
            --associate-public-ip-address \
            --tag-specifications "ResourceType=instance,Tags=[{Key=Name,Value=TestPublicInstance-GHA},{Key=Environment,Value=Test}]" \
            --query 'Instances[0].InstanceId' \
            --output text)
          
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "✅ Created instance: $INSTANCE_ID"

      - name: Wait for CloudTrail and remediation
        run: |
          echo "Waiting 3 minutes for CloudTrail event and policy execution..."
          sleep 180

      - name: Check instance status
        run: |
          INSTANCE_ID="${{ steps.create-instance.outputs.instance_id }}"
          
          STATE=$(aws ec2 describe-instances \
            --instance-ids $INSTANCE_ID \
            --query 'Reservations[0].Instances[0].State.Name' \
            --output text 2>/dev/null || echo "terminated")
          
          echo "Instance $INSTANCE_ID state: $STATE"
          
          if [ "$STATE" = "terminated" ] || [ "$STATE" = "terminating" ]; then
            echo "✅ Instance was successfully terminated by Cloud Custodian"
          else
            echo "⚠️ Instance is still running (state: $STATE)"
            echo "This may be expected if CloudTrail delay is longer than 3 minutes"
          fi

      - name: Configure AWS credentials (Central Account)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check Lambda logs
        run: |
          echo "Checking Lambda execution logs..."
          
          aws logs tail /aws/lambda/cloud-custodian-cross-account-executor \
            --since 5m \
            --format short \
            --filter-pattern "RunInstances"

  test-s3-remediation:
    name: Test S3 Remediation
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.test_type == 's3-remediation' || 
      github.event.inputs.test_type == 'all'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (Member Account)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ github.event.inputs.member_account_id }}:role/OrganizationAccountAccessRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Create public S3 bucket
        id: create-bucket
        run: |
          BUCKET_NAME="test-public-bucket-gha-$(date +%s)"
          
          echo "Creating test S3 bucket: $BUCKET_NAME"
          
          aws s3api create-bucket \
            --bucket $BUCKET_NAME \
            --region ${{ env.AWS_REGION }}
          
          # Remove public access block to make it "public"
          aws s3api delete-public-access-block \
            --bucket $BUCKET_NAME
          
          echo "bucket_name=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "✅ Created public bucket: $BUCKET_NAME"

      - name: Wait for CloudTrail and remediation
        run: |
          echo "Waiting 3 minutes for CloudTrail event and policy execution..."
          sleep 180

      - name: Check bucket public access block
        run: |
          BUCKET_NAME="${{ steps.create-bucket.outputs.bucket_name }}"
          
          echo "Checking public access block on bucket: $BUCKET_NAME"
          
          aws s3api get-public-access-block \
            --bucket $BUCKET_NAME \
            --query 'PublicAccessBlockConfiguration' || echo "No public access block set"
          
          # Check if all blocks are enabled
          BLOCK_PUBLIC_ACLS=$(aws s3api get-public-access-block --bucket $BUCKET_NAME --query 'PublicAccessBlockConfiguration.BlockPublicAcls' --output text 2>/dev/null || echo "false")
          
          if [ "$BLOCK_PUBLIC_ACLS" = "True" ]; then
            echo "✅ Public access block was successfully enabled by Cloud Custodian"
          else
            echo "⚠️ Public access block is not enabled yet"
            echo "This may be expected if CloudTrail delay is longer than 3 minutes"
          fi

      - name: Cleanup bucket
        if: always()
        run: |
          BUCKET_NAME="${{ steps.create-bucket.outputs.bucket_name }}"
          echo "Cleaning up test bucket: $BUCKET_NAME"
          
          aws s3 rb s3://$BUCKET_NAME --force || echo "Bucket may already be deleted"

      - name: Configure AWS credentials (Central Account)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check Lambda logs
        run: |
          echo "Checking Lambda execution logs..."
          
          aws logs tail /aws/lambda/cloud-custodian-cross-account-executor \
            --since 5m \
            --format short \
            --filter-pattern "CreateBucket"

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-event-forwarding, test-ec2-remediation, test-s3-remediation]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## Cross-Account Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Type:** ${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Member Account:** ${{ github.event.inputs.member_account_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-event-forwarding.result }}" = "success" ]; then
            echo "✅ Event Forwarding Test: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-event-forwarding.result }}" != "skipped" ]; then
            echo "❌ Event Forwarding Test: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-ec2-remediation.result }}" = "success" ]; then
            echo "✅ EC2 Remediation Test: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-ec2-remediation.result }}" != "skipped" ]; then
            echo "❌ EC2 Remediation Test: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.test-s3-remediation.result }}" = "success" ]; then
            echo "✅ S3 Remediation Test: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test-s3-remediation.result }}" != "skipped" ]; then
            echo "❌ S3 Remediation Test: Failed" >> $GITHUB_STEP_SUMMARY
          fi
