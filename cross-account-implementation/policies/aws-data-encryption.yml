policies:
  # ElastiCache Redis cluster without encryption at rest
  - name: elasticache-redis-no-encryption-at-rest
    resource: aws.cache-cluster
    description: Detect ElastiCache Redis clusters with encryption at rest disabled
    
    filters:
      - type: value
        key: Engine
        value: redis
      - type: value
        key: AtRestEncryptionEnabled
        value: false
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "⚠️ ElastiCache Redis Encryption at Rest Disabled - {{ region }}"
        violation_desc: |
          **ElastiCache Redis Cluster Without Encryption at Rest**
          
          **Cluster ID:** {{ resource.CacheClusterId }}
          **Engine:** {{ resource.Engine }} {{ resource.EngineVersion }}
          **Node Type:** {{ resource.CacheNodeType }}
          **Status:** {{ resource.CacheClusterStatus }}
          
          **Risk:** Data at rest is not encrypted.
          
          **Remediation:**
          Note: Cannot enable encryption on existing cluster. Must create new cluster:
          
          ```bash
          # Create new encrypted cluster
          aws elasticache create-replication-group \
            --replication-group-id {{ resource.CacheClusterId }}-encrypted \
            --replication-group-description "Encrypted cluster" \
            --engine redis \
            --cache-node-type {{ resource.CacheNodeType }} \
            --at-rest-encryption-enabled \
            --transit-encryption-enabled \
            --auth-token <strong-auth-token>
          
          # Migrate data and update application endpoints
          # Then delete old cluster
          aws elasticache delete-cache-cluster --cache-cluster-id {{ resource.CacheClusterId }}
          ```
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # ElastiCache Redis with in-transit encryption disabled (Replication Group)
  - name: elasticache-redis-no-transit-encryption-replication
    resource: aws.cache-cluster
    description: Detect ElastiCache Redis replication groups with in-transit encryption disabled
    
    filters:
      - type: value
        key: Engine
        value: redis
      - type: value
        key: TransitEncryptionEnabled
        value: false
      - type: value
        key: ReplicationGroupId
        value: present
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "⚠️ ElastiCache Redis In-Transit Encryption Disabled (Replication) - {{ region }}"
        violation_desc: |
          **ElastiCache Redis Replication Group Without In-Transit Encryption**
          
          **Cluster ID:** {{ resource.CacheClusterId }}
          **Replication Group ID:** {{ resource.ReplicationGroupId }}
          **Engine:** {{ resource.Engine }} {{ resource.EngineVersion }}
          
          **Risk:** Data in transit between nodes and clients is unencrypted.
          
          **Remediation:**
          Cannot enable on existing cluster. Must create new cluster with encryption enabled.
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # ElastiCache Redis with in-transit encryption disabled (Non-replication)
  - name: elasticache-redis-no-transit-encryption-standalone
    resource: aws.cache-cluster
    description: Detect standalone ElastiCache Redis clusters with in-transit encryption disabled
    
    filters:
      - type: value
        key: Engine
        value: redis
      - type: value
        key: TransitEncryptionEnabled
        value: false
      - type: value
        key: ReplicationGroupId
        value: absent
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "⚠️ ElastiCache Redis In-Transit Encryption Disabled (Standalone) - {{ region }}"
        violation_desc: |
          **Standalone ElastiCache Redis Without In-Transit Encryption**
          
          **Cluster ID:** {{ resource.CacheClusterId }}
          **Engine:** {{ resource.Engine }} {{ resource.EngineVersion }}
          
          **Risk:** Client-server communication is unencrypted.
          
          **Remediation:**
          Cannot enable on existing cluster. Must create new cluster with encryption enabled.
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # EFS with encryption at rest disabled
  - name: efs-encryption-disabled
    resource: aws.efs
    description: Detect Elastic File Systems without encryption at rest
    
    filters:
      - type: value
        key: Encrypted
        value: false
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "⚠️ EFS Encryption at Rest Disabled - {{ region }}"
        violation_desc: |
          **Elastic File System Without Encryption**
          
          **File System ID:** {{ resource.FileSystemId }}
          **Name:** {{ resource.Name }}
          **Performance Mode:** {{ resource.PerformanceMode }}
          **Lifecycle State:** {{ resource.LifeCycleState }}
          
          **Risk:** Data at rest is not encrypted.
          
          **Remediation:**
          Note: Cannot enable encryption on existing EFS. Must:
          1. Create new encrypted EFS
          2. Copy data to new EFS
          3. Update mount targets
          4. Delete old EFS
          
          ```bash
          # Create encrypted EFS
          aws efs create-file-system \
            --performance-mode {{ resource.PerformanceMode }} \
            --encrypted \
            --kms-key-id <kms-key-id> \
            --tags Key=Name,Value={{ resource.Name }}-encrypted
          
          # Copy data using AWS DataSync or rsync
          # Then delete old EFS
          aws efs delete-file-system --file-system-id {{ resource.FileSystemId }}
          ```
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # Elasticsearch domain encryption at rest disabled
  - name: elasticsearch-encryption-disabled
    resource: aws.elasticsearch
    description: Detect Elasticsearch domains with encryption at rest disabled
    
    filters:
      - type: value
        key: EncryptionAtRestOptions.Enabled
        value: false
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "⚠️ Elasticsearch Encryption at Rest Disabled - {{ region }}"
        violation_desc: |
          **Elasticsearch Domain Without Encryption at Rest**
          
          **Domain Name:** {{ resource.DomainName }}
          **Domain ID:** {{ resource.DomainId }}
          **Elasticsearch Version:** {{ resource.ElasticsearchVersion }}
          **Endpoint:** {{ resource.Endpoint }}
          
          **Risk:** Data stored in Elasticsearch is not encrypted.
          
          **Remediation:**
          Cannot enable encryption on existing domain. Must:
          1. Create manual snapshot
          2. Create new domain with encryption enabled
          3. Restore snapshot to new domain
          4. Update application endpoints
          
          ```bash
          # Create snapshot
          # (requires S3 bucket and IAM role for snapshots)
          
          # Create encrypted domain
          aws es create-elasticsearch-domain \
            --domain-name {{ resource.DomainName }}-encrypted \
            --elasticsearch-version {{ resource.ElasticsearchVersion }} \
            --encryption-at-rest-options Enabled=true,KmsKeyId=<kms-key-id> \
            --node-to-node-encryption-options Enabled=true
          
          # Restore snapshot to new domain
          # Update applications
          # Delete old domain
          aws es delete-elasticsearch-domain --domain-name {{ resource.DomainName }}
          ```
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # Kinesis streams not encrypted
  - name: kinesis-stream-not-encrypted
    resource: aws.kinesis
    description: Detect Kinesis streams without server-side encryption
    
    filters:
      - or:
        - type: value
          key: EncryptionType
          value: NONE
        - type: value
          key: EncryptionType
          value: absent
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "⚠️ Kinesis Stream Not Encrypted - {{ region }}"
        violation_desc: |
          **Kinesis Stream Without Server-Side Encryption**
          
          **Stream Name:** {{ resource.StreamName }}
          **Stream ARN:** {{ resource.StreamARN }}
          **Status:** {{ resource.StreamStatus }}
          **Shards:** {{ resource.Shards | length }}
          
          **Risk:** Data at rest in Kinesis is not encrypted.
          
          **Remediation:**
          ```bash
          # Enable encryption
          aws kinesis start-stream-encryption \
            --stream-name {{ resource.StreamName }} \
            --encryption-type KMS \
            --key-id <kms-key-id>
          ```
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue
      
      - type: encrypt
        key: <kms-key-alias>

  # Redshift cluster not encrypted
  - name: redshift-cluster-not-encrypted
    resource: aws.redshift
    description: Detect Redshift clusters without encryption
    
    filters:
      - type: value
        key: Encrypted
        value: false
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "⚠️ Redshift Cluster Not Encrypted - {{ region }}"
        violation_desc: |
          **Redshift Cluster Without Encryption**
          
          **Cluster ID:** {{ resource.ClusterIdentifier }}
          **Node Type:** {{ resource.NodeType }}
          **Number of Nodes:** {{ resource.NumberOfNodes }}
          **Database Name:** {{ resource.DBName }}
          **Endpoint:** {{ resource.Endpoint.Address }}
          
          **Risk:** Data warehouse data at rest is not encrypted.
          
          **Remediation:**
          Cannot enable encryption on existing cluster. Must:
          1. Create snapshot
          2. Copy snapshot with encryption
          3. Restore from encrypted snapshot
          
          ```bash
          # Create snapshot
          aws redshift create-cluster-snapshot \
            --cluster-identifier {{ resource.ClusterIdentifier }} \
            --snapshot-identifier {{ resource.ClusterIdentifier }}-snapshot
          
          # Copy with encryption
          aws redshift copy-cluster-snapshot \
            --source-snapshot-identifier {{ resource.ClusterIdentifier }}-snapshot \
            --target-snapshot-identifier {{ resource.ClusterIdentifier }}-encrypted \
            --kms-key-id <kms-key-id>
          
          # Restore encrypted cluster
          aws redshift restore-from-cluster-snapshot \
            --cluster-identifier {{ resource.ClusterIdentifier }}-encrypted \
            --snapshot-identifier {{ resource.ClusterIdentifier }}-encrypted
          ```
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # Redshift audit logging not to central bucket
  - name: redshift-logging-not-central
    resource: aws.redshift
    description: Detect Redshift clusters with audit logging enabled but not to central bucket
    
    filters:
      - type: value
        key: LoggingStatus.LoggingEnabled
        value: true
      - not:
        - type: value
          key: LoggingStatus.BucketName
          op: regex
          value: "^lp-cl.*"
    
    actions:
      - type: notify
        template: default.html
        priority_header: "3"
        subject: "⚠️ Redshift Audit Logging Not to Central Bucket - {{ region }}"
        violation_desc: |
          **Redshift Audit Logging Not to Central Bucket**
          
          **Cluster ID:** {{ resource.ClusterIdentifier }}
          **Current Logging Bucket:** {{ resource.LoggingStatus.BucketName }}
          **Required Bucket Prefix:** lp-cl*
          
          **Remediation:**
          ```bash
          aws redshift enable-logging \
            --cluster-identifier {{ resource.ClusterIdentifier }} \
            --bucket-name lp-cl-logging-bucket \
            --s3-key-prefix service=redshift/{{ resource.ClusterIdentifier }}/
          ```
        to:
          - compliance-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # SNS topic without server-side encryption
  - name: sns-topic-no-encryption
    resource: aws.sns
    description: Detect SNS topics with server-side encryption disabled
    
    filters:
      - type: value
        key: KmsMasterKeyId
        value: absent
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "⚠️ SNS Topic Without Server-Side Encryption - {{ region }}"
        violation_desc: |
          **SNS Topic Without Server-Side Encryption**
          
          **Topic ARN:** {{ resource.TopicArn }}
          **Topic Name:** {{ resource.DisplayName }}
          
          **Risk:** Messages at rest in SNS are not encrypted.
          
          **Remediation:**
          ```bash
          # Enable KMS encryption
          aws sns set-topic-attributes \
            --topic-arn {{ resource.TopicArn }} \
            --attribute-name KmsMasterKeyId \
            --attribute-value <kms-key-id>
          ```
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue
      
      - type: set-encryption
        key: <kms-key-alias>
