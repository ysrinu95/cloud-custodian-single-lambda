policies:
  - name: guardduty-findings-auto-archive
    resource: aws.account
    description: |
      Automatically process high-severity GuardDuty findings and send alerts.
      This policy detects Backdoor, Trojan, Cryptocurrency, and UnauthorizedAccess threats.
    
    filters:
      - type: event
        key: detail.severity
        value: 7
        op: gte
    
    actions:
      # Send critical security alert (archival not supported for guardduty-finding resource)
      - type: notify
        template: default
        priority_header: 1
        subject: "[GUARDDUTY ALERT] {{ type }} - Severity {{ severity }}"
        violation_desc: |
          **GuardDuty Threat Detection**
          
          Finding ID: {{ id }}
          Type: {{ type }}
          Severity: {{ severity }}/10
          Title: {{ title }}
          
          **Resource Details:**
          {% if detail.resource.instanceDetails %}
          - Instance ID: {{ detail.resource.instanceDetails.instanceId }}
          - Instance Type: {{ detail.resource.instanceDetails.instanceType }}
          - Launch Time: {{ detail.resource.instanceDetails.launchTime }}
          - Availability Zone: {{ detail.resource.instanceDetails.availabilityZone }}
          {% elif detail.resource.accessKeyDetails %}
          - IAM User: {{ detail.resource.accessKeyDetails.userName }}
          - Access Key: {{ detail.resource.accessKeyDetails.accessKeyId }}
          {% endif %}
          
          **Threat Information:**
          - First Seen: {{ detail.service.eventFirstSeen }}
          - Last Seen: {{ detail.service.eventLastSeen }}
          - Occurrences: {{ detail.service.count }}
          {% if detail.service.action.dnsRequestAction %}
          - Malicious Domain: {{ detail.service.action.dnsRequestAction.domain }}
          {% endif %}
          
          **Description:** {{ description }}
          
          **IMMEDIATE ACTIONS REQUIRED:**
          {% if 'Backdoor:EC2' in type or 'Trojan:EC2' in type %}
          1. Terminate instance {{ detail.resource.instanceDetails.instanceId }} immediately
          2. Create forensic snapshots if needed
          3. Review CloudTrail for instance launch details
          4. Investigate compromise vector
          {% elif 'CryptoCurrency:EC2' in type %}
          1. Terminate instance {{ detail.resource.instanceDetails.instanceId }} immediately
          2. Review IAM credentials that launched the instance
          3. Check for unauthorized access keys
          {% elif 'UnauthorizedAccess:IAMUser' in type or 'CredentialAccess:IAMUser' in type %}
          1. Disable all access keys for user {{ detail.resource.accessKeyDetails.userName }}
          2. Rotate credentials immediately
          3. Review CloudTrail for suspicious activity
          4. Consider deleting compromised user
          {% else %}
          1. Review the finding in GuardDuty console
          2. Investigate affected resources
          3. Take appropriate remediation actions
          {% endif %}
          
          
        to:
          - security-team@example.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

