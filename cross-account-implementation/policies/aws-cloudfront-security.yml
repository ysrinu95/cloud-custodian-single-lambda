policies:
  # CloudFront using insecure SSL protocols
  - name: cloudfront-insecure-ssl-protocols
    resource: aws.distribution
    description: Detect CloudFront distributions using insecure SSL/TLS protocols (TLS 1.0/1.1)
    
    filters:
      - or:
        - type: value
          key: DistributionConfig.ViewerCertificate.MinimumProtocolVersion
          value: TLSv1
        - type: value
          key: DistributionConfig.ViewerCertificate.MinimumProtocolVersion
          value: TLSv1_2016
        - type: value
          key: DistributionConfig.ViewerCertificate.MinimumProtocolVersion
          value: TLSv1.1_2016
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "⚠️ CloudFront Using Insecure SSL Protocols - {{ region }}"
        violation_desc: |
          **CloudFront Distribution Using Insecure TLS Version**
          
          **Distribution ID:** {{ resource.Id }}
          **Domain Name:** {{ resource.DomainName }}
          **Current TLS Version:** {{ resource.DistributionConfig.ViewerCertificate.MinimumProtocolVersion }}
          **Recommended:** TLSv1.2_2021 or higher
          
          **Risk:** TLS 1.0 and 1.1 have known vulnerabilities.
          
          **Remediation:**
          ```bash
          # Get current config
          aws cloudfront get-distribution-config --id {{ resource.Id }} > dist-config.json
          
          # Update MinimumProtocolVersion to TLSv1.2_2021
          # Edit dist-config.json and update:
          # "MinimumProtocolVersion": "TLSv1.2_2021"
          
          # Apply updated config
          aws cloudfront update-distribution \
            --id {{ resource.Id }} \
            --distribution-config file://dist-config.json \
            --if-match <etag-from-get-config>
          ```
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # CloudFront access logging not to central bucket
  - name: cloudfront-logging-not-central
    resource: aws.distribution
    description: Detect CloudFront distributions with logging enabled but not to central logging bucket
    
    filters:
      - type: value
        key: DistributionConfig.Logging.Enabled
        value: true
      - not:
        - type: value
          key: DistributionConfig.Logging.Bucket
          op: regex
          value: "^lp-cl.*"
      - not:
        - type: value
          key: DistributionConfig.Logging.Prefix
          op: regex
          value: ".*service=cloudfront.*"
    
    actions:
      - type: notify
        template: default.html
        priority_header: "3"
        subject: "⚠️ CloudFront Logging Not to Central Bucket - {{ region }}"
        violation_desc: |
          **CloudFront Access Logging Not to Central Bucket**
          
          **Distribution ID:** {{ resource.Id }}
          **Current Logging Bucket:** {{ resource.DistributionConfig.Logging.Bucket }}
          **Current Logging Prefix:** {{ resource.DistributionConfig.Logging.Prefix }}
          **Required Bucket Prefix:** lp-cl*
          **Required Prefix Pattern:** service=cloudfront
          
          **Remediation:**
          ```bash
          # Update logging configuration
          aws cloudfront get-distribution-config --id {{ resource.Id }} > dist-config.json
          
          # Update Logging section:
          # "Logging": {
          #   "Enabled": true,
          #   "Bucket": "lp-cl-logging-bucket.s3.amazonaws.com",
          #   "Prefix": "service=cloudfront/{{ resource.Id }}/"
          # }
          
          aws cloudfront update-distribution \
            --id {{ resource.Id }} \
            --distribution-config file://dist-config.json \
            --if-match <etag>
          ```
        to:
          - compliance-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # CloudFront with TLS version 1.1 or lower
  - name: cloudfront-tls-v11-or-lower
    resource: aws.distribution
    description: Detect CloudFront distributions with TLS version 1.1 or lower
    
    filters:
      - or:
        - type: value
          key: DistributionConfig.ViewerCertificate.MinimumProtocolVersion
          value: SSLv3
        - type: value
          key: DistributionConfig.ViewerCertificate.MinimumProtocolVersion
          value: TLSv1
        - type: value
          key: DistributionConfig.ViewerCertificate.MinimumProtocolVersion
          value: TLSv1_2016
        - type: value
          key: DistributionConfig.ViewerCertificate.MinimumProtocolVersion
          value: TLSv1.1_2016
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "⚠️ CloudFront TLS Version 1.1 or Lower - {{ region }}"
        violation_desc: |
          **CloudFront Distribution Using TLS 1.1 or Lower**
          
          **Distribution ID:** {{ resource.Id }}
          **Domain Name:** {{ resource.DomainName }}
          **Current TLS Version:** {{ resource.DistributionConfig.ViewerCertificate.MinimumProtocolVersion }}
          
          **Risk:** Deprecated TLS versions vulnerable to attacks.
          
          **Action Required:** Upgrade to TLSv1.2_2021 or TLSv1.3
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue
