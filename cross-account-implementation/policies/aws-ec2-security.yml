policies:
  # AMI publicly accessible - realtime/periodic
  - name: ami-publicly-accessible
    resource: aws.ami
    description: Detect Amazon Machine Images (AMIs) that are publicly accessible
    
    filters:
      - type: value
        key: Public
        value: true
    
    actions:
      - type: notify
        template: default.html
        priority_header: "1"
        subject: "üö® CRITICAL: AMI Publicly Accessible - {{ region }}"
        violation_desc: |
          **Amazon Machine Image Is Publicly Accessible**
          
          **AMI ID:** {{ resource.ImageId }}
          **Name:** {{ resource.Name }}
          **Owner:** {{ resource.OwnerId }}
          **Creation Date:** {{ resource.CreationDate }}
          
          **Risk:** Public AMIs can expose sensitive data, configurations, or intellectual property.
          
          **Remediation:**
          ```bash
          # Make AMI private
          aws ec2 modify-image-attribute \
            --image-id {{ resource.ImageId }} \
            --launch-permission "Remove=[{Group=all}]"
          ```
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue
      
      - type: remove-launch-permissions
        accounts: matched

  # EBS snapshot not encrypted - realtime/periodic
  - name: ebs-snapshot-unencrypted
    resource: aws.ebs-snapshot
    description: Detect EBS snapshots that are not encrypted
    
    filters:
      - type: value
        key: Encrypted
        value: false
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "‚ö†Ô∏è EBS Snapshot Not Encrypted - {{ region }}"
        violation_desc: |
          **EBS Snapshot Without Encryption**
          
          **Snapshot ID:** {{ resource.SnapshotId }}
          **Volume ID:** {{ resource.VolumeId }}
          **Volume Size:** {{ resource.VolumeSize }} GB
          **Start Time:** {{ resource.StartTime }}
          **Owner:** {{ resource.OwnerId }}
          
          **Risk:** Unencrypted snapshots can expose data at rest.
          
          **Remediation:**
          ```bash
          # Copy snapshot with encryption enabled
          aws ec2 copy-snapshot \
            --source-region {{ region }} \
            --source-snapshot-id {{ resource.SnapshotId }} \
            --description "Encrypted copy of {{ resource.SnapshotId }}" \
            --encrypted \
            --kms-key-id <kms-key-id>
          
          # Delete unencrypted snapshot after verification
          aws ec2 delete-snapshot --snapshot-id {{ resource.SnapshotId }}
          ```
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # EBS snapshots accessible to public - realtime/periodic
  - name: ebs-snapshot-public
    resource: aws.ebs-snapshot
    description: Detect EBS snapshots that are publicly accessible
    
    filters:
      - type: cross-account
        whitelist_endpoints:
          - '{{account_id}}'
    
    actions:
      - type: notify
        template: default.html
        priority_header: "1"
        subject: "üö® CRITICAL: EBS Snapshot Publicly Accessible - {{ region }}"
        violation_desc: |
          **EBS Snapshot Is Publicly Accessible**
          
          **Snapshot ID:** {{ resource.SnapshotId }}
          **Volume ID:** {{ resource.VolumeId }}
          **Volume Size:** {{ resource.VolumeSize }} GB
          **Description:** {{ resource.Description }}
          
          **Risk:** Public EBS snapshots can expose sensitive data to unauthorized parties.
          
          **Remediation:**
          ```bash
          # Remove public permissions
          aws ec2 modify-snapshot-attribute \
            --snapshot-id {{ resource.SnapshotId }} \
            --create-volume-permission "Remove=[{Group=all}]"
          ```
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue
      
      - type: set-permissions
        remove-accounts: matched

  # EC2 instances with unencrypted EBS volumes - cloudtrail/periodic
  - name: ec2-unencrypted-ebs-volume
    resource: aws.ec2
    description: Detect EC2 instances with unencrypted EBS volumes attached
    
    filters:
      - type: ebs
        key: Encrypted
        value: false
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "‚ö†Ô∏è EC2 Instance with Unencrypted EBS Volume - {{ region }}"
        violation_desc: |
          **EC2 Instance Has Unencrypted EBS Volume**
          
          **Instance ID:** {{ resource.InstanceId }}
          **Instance Name:** {{ resource.Tags[?Key=='Name'].Value | [0] }}
          **Instance Type:** {{ resource.InstanceType }}
          **State:** {{ resource.State.Name }}
          **Unencrypted Volumes:** {{ resource.BlockDeviceMappings[?Ebs.Encrypted==`false`].Ebs.VolumeId }}
          
          **Risk:** Unencrypted EBS volumes can expose data at rest.
          
          **Remediation:**
          1. Create encrypted snapshot of unencrypted volume
          2. Create new encrypted volume from snapshot
          3. Stop instance and swap volumes
          
          ```bash
          # Create snapshot
          aws ec2 create-snapshot \
            --volume-id <volume-id> \
            --description "Snapshot for encryption"
          
          # Copy with encryption
          aws ec2 copy-snapshot \
            --source-snapshot-id <snapshot-id> \
            --encrypted \
            --kms-key-id <kms-key-id>
          
          # Create encrypted volume
          aws ec2 create-volume \
            --snapshot-id <encrypted-snapshot-id> \
            --availability-zone {{ resource.Placement.AvailabilityZone }} \
            --encrypted
          ```
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # EC2 instance older than 30 days - periodic
  - name: ec2-instance-older-than-30-days
    resource: aws.ec2
    description: Detect EC2 instances older than 30 days (potential compliance issue)
    
    filters:
      - type: instance-age
        days: 30
        op: gte
    
    actions:
      - type: notify
        template: default.html
        priority_header: "3"
        subject: "‚ÑπÔ∏è EC2 Instance Older Than 30 Days - {{ region }}"
        violation_desc: |
          **EC2 Instance Running for Over 30 Days**
          
          **Instance ID:** {{ resource.InstanceId }}
          **Instance Name:** {{ resource.Tags[?Key=='Name'].Value | [0] }}
          **Launch Time:** {{ resource.LaunchTime }}
          **Instance Age:** {{ resource.c7n.InstanceAge }} days
          **Instance Type:** {{ resource.InstanceType }}
          
          **Action Required:** Review if instance should be patched, updated, or replaced.
          
          **Recommendations:**
          - Apply latest security patches
          - Review for compliance with patch management policy
          - Consider recreating from latest AMI
          - Tag with exception if long-running is required
        to:
          - operations-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # EC2 Instance Metadata Service v1 enabled - cloudtrail/periodic
  - name: ec2-imdsv1-enabled
    resource: aws.ec2
    description: Detect EC2 instances with IMDSv1 enabled (should use IMDSv2 only)
    
    filters:
      - or:
        - type: value
          key: MetadataOptions.HttpTokens
          value: optional
        - type: value
          key: MetadataOptions.HttpTokens
          value: absent
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "‚ö†Ô∏è EC2 Instance Metadata Service v1 Enabled - {{ region }}"
        violation_desc: |
          **EC2 Instance Using Insecure IMDSv1**
          
          **Instance ID:** {{ resource.InstanceId }}
          **Instance Name:** {{ resource.Tags[?Key=='Name'].Value | [0] }}
          **Current IMDS Config:** {{ resource.MetadataOptions.HttpTokens }}
          
          **Risk:** IMDSv1 is vulnerable to SSRF attacks that can leak credentials.
          
          **Remediation:**
          ```bash
          # Require IMDSv2 only
          aws ec2 modify-instance-metadata-options \
            --instance-id {{ resource.InstanceId }} \
            --http-tokens required \
            --http-put-response-hop-limit 1
          ```
        to:
          - security-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue
      
      - type: set-metadata-access
        enforce-imdsv2: true
