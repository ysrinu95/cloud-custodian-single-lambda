name: Integration Test - End-to-End Auto Detection

on:
  workflow_dispatch:
    inputs:
      cleanup:
        description: 'Cleanup test resources after test'
        required: true
        type: boolean
        default: true
      wait_time:
        description: 'Wait time (minutes) to monitor for EventBridge trigger'
        required: true
        type: number
        default: 2

env:
  AWS_REGION: us-east-1
  PYTHON_VERSION: "3.11"
  TEST_PREFIX: "custodian-test"

permissions:
  id-token: write
  contents: read

jobs:
  # ======================================================================
  # Job 1: Create Test Resources
  # ======================================================================
  create-test-resources:
    name: Create Public S3 Bucket
    runs-on: ubuntu-latest
    outputs:
      public_bucket: ${{ steps.resources.outputs.public_bucket }}
      bucket_creation_time: ${{ steps.resources.outputs.bucket_creation_time }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-CloudCustodian-Role
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Create public S3 bucket
        id: resources
        run: |
          TIMESTAMP=$(date +%s)
          BUCKET_NAME="${TEST_PREFIX}-public-${TIMESTAMP}"
          
          echo "ü™£ Creating public S3 bucket: $BUCKET_NAME"
          
          # Create bucket
          aws s3 mb s3://$BUCKET_NAME --region ${{ env.AWS_REGION }}
          
          # Disable block public access settings
          aws s3api put-public-access-block \
            --bucket $BUCKET_NAME \
            --public-access-block-configuration \
              "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"
          
          # Apply public ACL
          aws s3api put-bucket-acl \
            --bucket $BUCKET_NAME \
            --acl public-read
          
          # Verify it's public
          echo ""
          echo "üìã Bucket ACL:"
          aws s3api get-bucket-acl --bucket $BUCKET_NAME
          
          # Add tags
          aws s3api put-bucket-tagging \
            --bucket $BUCKET_NAME \
            --tagging 'TagSet=[{Key=TestType,Value=PublicBucket},{Key=Owner,Value=IntegrationTest},{Key=Environment,Value=test}]'
          
          CREATION_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Output
          echo "public_bucket=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "bucket_creation_time=$CREATION_TIME" >> $GITHUB_OUTPUT
          
          cat <<EOF > test-resources.md
          ## üß™ Test Resource Created
          
          **Timestamp:** $CREATION_TIME
          
          ### Public S3 Bucket
          
          - **Bucket Name:** \`$BUCKET_NAME\`
          - **Status:** ‚ö†Ô∏è **PUBLIC** (Block Public Access: Disabled, ACL: public-read)
          - **Tags:** TestType=PublicBucket, Owner=IntegrationTest
          
          ### Expected Behavior
          
          Cloud Custodian should automatically:
          1. Detect the public bucket via EventBridge (CloudTrail events)
          2. Trigger Lambda function
          3. Remove public access or apply remediation
          4. Log actions to CloudWatch
          
          ### Monitoring
          
          The workflow will monitor for ${{ inputs.wait_time }} minutes to observe:
          - EventBridge rule trigger
          - Lambda function invocation
          - Policy execution and remediation
          
          EOF
          
          cat test-resources.md
          
          echo ""
          echo "‚ö†Ô∏è PUBLIC BUCKET CREATED: $BUCKET_NAME"
          echo "‚è≥ Waiting for Cloud Custodian to detect and remediate..."
      
      - name: Upload test resources report
        uses: actions/upload-artifact@v4
        with:
          name: test-resources-report
          path: test-resources.md
          retention-days: 7

  # ======================================================================
  # Job 2: Deploy Lambda with Test Policy
  # ======================================================================
  deploy-test-lambda:
    name: Deploy Lambda Infrastructure
    runs-on: ubuntu-latest
    needs: create-test-resources
    outputs:
      lambda_function_name: ${{ steps.terraform-output.outputs.lambda_function_name }}
      eventbridge_rule_name: ${{ steps.terraform-output.outputs.eventbridge_rule_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-CloudCustodian-Role
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Build Lambda layer
        run: |
          echo "üì¶ Building Cloud Custodian layer..."
          mkdir -p layers/python
          pip install c7n c7n-org -t layers/python/
          
          # Remove unnecessary files to reduce size
          find layers/python -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find layers/python -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          
          cd layers
          zip -r ../cloud-custodian-layer.zip python/
          cd ..
          
          mv cloud-custodian-layer.zip layers/
          ls -lh layers/cloud-custodian-layer.zip
      
      - name: Create Lambda function zip
        run: |
          mkdir -p lambda-package/policies
          cp src/lambda_native.py lambda-package/lambda_function.py
          cp policies/test-policy.yml lambda-package/policies/
          
          cd lambda-package
          zip -r ../lambda-function.zip .
          cd ..
          
          mv lambda-function.zip terraform/
          ls -lh terraform/lambda-function.zip
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false
      
      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
            -backend-config="key=cloud-custodian/integration-test/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}"
      
      - name: Terraform Apply
        working-directory: terraform
        run: |
          terraform apply -auto-approve \
            -var="environment=test" \
            -var="lambda_execution_mode=native" \
            -var="aws_region=${{ env.AWS_REGION }}"
      
      - name: Get Terraform outputs
        id: terraform-output
        working-directory: terraform
        run: |
          LAMBDA_NAME=$(terraform output -raw lambda_function_name)
          RULE_NAME=$(terraform output -raw eventbridge_rule_name 2>/dev/null || echo "custodian-schedule-test")
          
          echo "lambda_function_name=$LAMBDA_NAME" >> $GITHUB_OUTPUT
          echo "eventbridge_rule_name=$RULE_NAME" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Lambda deployed: $LAMBDA_NAME"
          echo "‚úÖ EventBridge rule: $RULE_NAME"

  # ======================================================================
  # Job 3: Monitor EventBridge and Lambda Automatically
  # ======================================================================
  trigger-and-monitor:
    name: Monitor Automatic Detection and Remediation
    runs-on: ubuntu-latest
    needs: [create-test-resources, deploy-test-lambda]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-CloudCustodian-Role
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Wait for EventBridge to trigger Lambda
        run: |
          echo "‚è≥ Waiting ${{ inputs.wait_time }} minutes for EventBridge to detect S3 event and trigger Lambda..."
          echo ""
          echo "What's happening:"
          echo "1. CloudTrail logs S3 bucket creation event"
          echo "2. EventBridge rule matches the event pattern"
          echo "3. Lambda function gets triggered automatically"
          echo "4. Cloud Custodian policy executes"
          echo "5. Public bucket gets remediated"
          echo ""
          
          WAIT_SECONDS=$((inputs.wait_time * 60))
          
          # Show progress
          for i in $(seq 1 ${{ inputs.wait_time }}); do
            echo "‚è≥ Minute $i/${{ inputs.wait_time }} - Monitoring..."
            sleep 60
          done
          
          echo "‚úÖ Monitoring period complete"
      
      - name: Check Lambda invocations
        run: |
          echo "üîç Checking Lambda invocation metrics..."
          
          FUNCTION_NAME="${{ needs.deploy-test-lambda.outputs.lambda_function_name }}"
          START_TIME=$(date -u -d "${{ needs.create-test-resources.outputs.bucket_creation_time }}" +%s)000
          END_TIME=$(date +%s)000
          
          echo "Querying Lambda metrics from ${{ needs.create-test-resources.outputs.bucket_creation_time }} to now..."
          
          # Check invocation count
          INVOCATIONS=$(aws cloudwatch get-metric-statistics \
            --namespace AWS/Lambda \
            --metric-name Invocations \
            --dimensions Name=FunctionName,Value=$FUNCTION_NAME \
            --start-time ${{ needs.create-test-resources.outputs.bucket_creation_time }} \
            --end-time $(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --period 60 \
            --statistics Sum \
            --region ${{ env.AWS_REGION }})
          
          echo "Lambda Invocations:"
          echo "$INVOCATIONS" | jq .
          
          INVOCATION_COUNT=$(echo "$INVOCATIONS" | jq '[.Datapoints[].Sum] | add // 0')
          echo ""
          echo "Total invocations: $INVOCATION_COUNT"
          
          if [ "$INVOCATION_COUNT" -gt 0 ]; then
            echo "‚úÖ Lambda was invoked automatically!"
          else
            echo "‚ö†Ô∏è No automatic invocations detected. EventBridge may need more time or may not be configured."
          fi
      
      - name: Check CloudWatch Logs
        run: |
          echo "üìã Checking Lambda execution logs..."
          
          LOG_GROUP="/aws/lambda/${{ needs.deploy-test-lambda.outputs.lambda_function_name }}"
          
          echo "Recent logs (last ${{ inputs.wait_time }} minutes):"
          aws logs tail "$LOG_GROUP" \
            --since ${{ inputs.wait_time }}m \
            --format short \
            --region ${{ env.AWS_REGION }} || echo "No logs found"
      
      - name: Verify bucket remediation
        id: verify
        run: |
          echo "üîç Verifying if public bucket was remediated..."
          
          BUCKET="${{ needs.create-test-resources.outputs.public_bucket }}"
          
          echo "Checking public access block settings:"
          PUBLIC_ACCESS=$(aws s3api get-public-access-block \
            --bucket $BUCKET \
            --region ${{ env.AWS_REGION }} 2>&1) || true
          
          echo "$PUBLIC_ACCESS"
          
          echo ""
          echo "Checking bucket ACL:"
          BUCKET_ACL=$(aws s3api get-bucket-acl \
            --bucket $BUCKET \
            --region ${{ env.AWS_REGION }})
          
          echo "$BUCKET_ACL" | jq .
          
          # Check if public access was blocked
          if echo "$PUBLIC_ACCESS" | grep -q "BlockPublicAcls.*true"; then
            echo ""
            echo "‚úÖ SUCCESS: Public access has been BLOCKED!"
            echo "status=remediated" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "‚ö†Ô∏è WARNING: Bucket is still public. Policy may need more time or may require different configuration."
            echo "status=still_public" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate test results report
        run: |
          cat <<EOF > integration-test-results.md
          ## üß™ Automatic Detection Integration Test Results
          
          **Test Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Lambda Function:** ${{ needs.deploy-test-lambda.outputs.lambda_function_name }}
          **Monitoring Duration:** ${{ inputs.wait_time }} minutes
          
          ### Test Resource
          
          - **Public S3 Bucket:** ${{ needs.create-test-resources.outputs.public_bucket }}
          - **Created At:** ${{ needs.create-test-resources.outputs.bucket_creation_time }}
          
          ### Automatic Detection Flow
          
          1. ‚úÖ Public S3 bucket created
          2. üìã CloudTrail logged the event
          3. ‚ö° EventBridge rule evaluated event
          4. üöÄ Lambda function triggered (if rule matched)
          5. üîí Cloud Custodian policy executed
          6. üìä Results logged to CloudWatch
          
          ### Remediation Status
          
          **Status:** ${{ steps.verify.outputs.status }}
          
          $(if [ "${{ steps.verify.outputs.status }}" == "remediated" ]; then
            echo "‚úÖ **SUCCESS** - Public access was automatically blocked!"
            echo ""
            echo "The integration test proves:"
            echo "- EventBridge detected the S3 event"
            echo "- Lambda was triggered automatically"
            echo "- Cloud Custodian policy executed successfully"
            echo "- Public bucket was remediated"
          else
            echo "‚ö†Ô∏è **PENDING/FAILED** - Bucket is still public"
            echo ""
            echo "Possible reasons:"
            echo "- EventBridge rule may need different event pattern"
            echo "- CloudTrail events may be delayed"
            echo "- Policy may need adjustment"
            echo "- Lambda may need more time to execute"
          fi)
          
          ### CloudWatch Logs
          
          Check detailed execution logs:
          \`/aws/lambda/${{ needs.deploy-test-lambda.outputs.lambda_function_name }}\`
          
          ### Next Steps
          
          ${{ inputs.cleanup && '- ‚úÖ Test resources will be cleaned up automatically' || '- ‚ö†Ô∏è Remember to manually clean up test resources' }}
          
          EOF
          
          cat integration-test-results.md
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: integration-test-results.md
          retention-days: 30

  # ======================================================================
  # Job 4: Cleanup Test Resources
  # ======================================================================
  cleanup:
    name: Cleanup Test Resources
    runs-on: ubuntu-latest
    needs: [create-test-resources, deploy-test-lambda, trigger-and-monitor]
    if: always() && inputs.cleanup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-CloudCustodian-Role
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Delete test S3 bucket
        run: |
          echo "üßπ Cleaning up test S3 bucket..."
          
          # Delete bucket
          aws s3 rb s3://${{ needs.create-test-resources.outputs.public_bucket }} --force || echo "Bucket already deleted or doesn't exist"
          
          echo "‚úÖ Test S3 bucket cleaned up"
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: Destroy Lambda infrastructure
        working-directory: terraform
        run: |
          echo "üßπ Destroying test Lambda infrastructure..."
          
          terraform init \
            -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
            -backend-config="key=cloud-custodian/integration-test/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}"
          
          terraform destroy -auto-approve \
            -var="environment=test" \
            -var="lambda_execution_mode=native" \
            -var="aws_region=${{ env.AWS_REGION }}"
          
          echo "‚úÖ Lambda infrastructure destroyed"
      
      - name: Cleanup summary
        run: |
          cat <<EOF
          ## üßπ Cleanup Complete
          
          **Cleaned up:**
          - ‚úÖ Test S3 bucket deleted
          - ‚úÖ Lambda function destroyed
          - ‚úÖ EventBridge rules removed
          - ‚úÖ CloudWatch log groups deleted
          - ‚úÖ IAM roles cleaned up
          
          **Automatic detection test completed!**
          
          The test verified that Cloud Custodian can automatically:
          - Detect resource changes via EventBridge
          - Execute policies without manual triggers
          - Remediate non-compliant resources in real-time
          EOF
