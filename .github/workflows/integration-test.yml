name: Integration Test - Monitor Existing Infrastructure

on:
  workflow_dispatch:
    inputs:
      lambda_function_name:
        description: 'Lambda function name to monitor'
        required: true
        type: string
        default: 'cloud-custodian-executor-prod'
      cleanup:
        description: 'Cleanup test bucket after test'
        required: true
        type: boolean
        default: true
      wait_time:
        description: 'Wait time (minutes) to monitor for EventBridge trigger'
        required: true
        type: number
        default: 2

env:
  AWS_REGION: us-east-1
  TEST_PREFIX: "custodian-test"

permissions:
  id-token: write
  contents: read

jobs:
  # ======================================================================
  # Job 1: Create Public S3 Bucket
  # ======================================================================
  create-public-bucket:
    name: Create Public S3 Bucket
    runs-on: ubuntu-latest
    outputs:
      public_bucket: ${{ steps.create.outputs.public_bucket }}
      bucket_creation_time: ${{ steps.create.outputs.bucket_creation_time }}
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-CloudCustodian-Role
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Create public S3 bucket
        id: create
        run: |
          TIMESTAMP=$(date +%s)
          BUCKET_NAME="${TEST_PREFIX}-public-${TIMESTAMP}"
          
          echo "ğŸª£ Creating public S3 bucket: $BUCKET_NAME"
          
          # Create bucket with ACLs enabled
          aws s3api create-bucket \
            --bucket $BUCKET_NAME \
            --region ${{ env.AWS_REGION }} \
            --object-ownership BucketOwnerPreferred
          
          # Disable block public access settings
          aws s3api put-public-access-block \
            --bucket $BUCKET_NAME \
            --public-access-block-configuration \
              "BlockPublicAcls=false,IgnorePublicAcls=false,BlockPublicPolicy=false,RestrictPublicBuckets=false"
          
          # Apply public bucket policy (more reliable than ACLs)
          aws s3api put-bucket-policy \
            --bucket $BUCKET_NAME \
            --policy "{
              \"Version\": \"2012-10-17\",
              \"Statement\": [{
                \"Sid\": \"PublicReadGetObject\",
                \"Effect\": \"Allow\",
                \"Principal\": \"*\",
                \"Action\": \"s3:GetObject\",
                \"Resource\": \"arn:aws:s3:::$BUCKET_NAME/*\"
              }]
            }"
          
          # Verify it's public
          echo ""
          echo "ğŸ“‹ Bucket Policy:"
          aws s3api get-bucket-policy --bucket $BUCKET_NAME
          
          echo ""
          echo "ğŸ“‹ Public Access Block (should be disabled):"
          aws s3api get-public-access-block --bucket $BUCKET_NAME
          
          # Add tags
          aws s3api put-bucket-tagging \
            --bucket $BUCKET_NAME \
            --tagging 'TagSet=[{Key=TestType,Value=PublicBucket},{Key=Owner,Value=IntegrationTest},{Key=Environment,Value=test}]'
          
          CREATION_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Output
          echo "public_bucket=$BUCKET_NAME" >> $GITHUB_OUTPUT
          echo "bucket_creation_time=$CREATION_TIME" >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… PUBLIC BUCKET CREATED: $BUCKET_NAME"
          echo "â³ Waiting for EventBridge to detect and trigger Lambda..."

  # ======================================================================
  # Job 2: Monitor EventBridge and Lambda
  # ======================================================================
  monitor-execution:
    name: Monitor Automatic Detection
    runs-on: ubuntu-latest
    needs: create-public-bucket
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-CloudCustodian-Role
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Wait for EventBridge trigger
        run: |
          echo "â³ Waiting ${{ inputs.wait_time }} minutes for automatic detection..."
          echo ""
          echo "ğŸ“Š What's happening:"
          echo "  1. Public S3 bucket created: ${{ needs.create-public-bucket.outputs.public_bucket }}"
          echo "  2. CloudTrail logs the S3 API events"
          echo "  3. EventBridge rule detects S3 changes"
          echo "  4. Lambda function (${{ inputs.lambda_function_name }}) gets triggered"
          echo "  5. Cloud Custodian policy executes"
          echo "  6. Public bucket gets remediated"
          echo ""
          
          # Monitor in intervals
          for i in $(seq 1 ${{ inputs.wait_time }}); do
            echo "â³ Minute $i/${{ inputs.wait_time }}..."
            sleep 60
          done
          
          echo "âœ… Monitoring period complete"
      
      - name: Check Lambda invocations
        run: |
          echo "ğŸ” Checking Lambda invocation metrics..."
          
          FUNCTION_NAME="${{ inputs.lambda_function_name }}"
          
          # Get metrics for last 10 minutes
          INVOCATIONS=$(aws cloudwatch get-metric-statistics \
            --namespace AWS/Lambda \
            --metric-name Invocations \
            --dimensions Name=FunctionName,Value=$FUNCTION_NAME \
            --start-time $(date -u -d '10 minutes ago' +"%Y-%m-%dT%H:%M:%SZ") \
            --end-time $(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --period 60 \
            --statistics Sum \
            --region ${{ env.AWS_REGION }})
          
          echo "Lambda Invocations (last 10 minutes):"
          echo "$INVOCATIONS" | jq .
          
          INVOCATION_COUNT=$(echo "$INVOCATIONS" | jq '[.Datapoints[].Sum] | add // 0')
          echo ""
          
          if [ "$INVOCATION_COUNT" -gt 0 ]; then
            echo "âœ… Lambda was invoked $INVOCATION_COUNT time(s) automatically!"
          else
            echo "âš ï¸ No automatic invocations detected in the last 10 minutes."
            echo "   EventBridge may need more time, or the event pattern may not match."
          fi
      
      - name: Check CloudWatch Logs
        run: |
          echo "ğŸ“‹ Checking Lambda execution logs..."
          
          LOG_GROUP="/aws/lambda/${{ inputs.lambda_function_name }}"
          
          echo "Recent logs (last ${{ inputs.wait_time }} minutes):"
          aws logs tail "$LOG_GROUP" \
            --since ${{ inputs.wait_time }}m \
            --format short \
            --region ${{ env.AWS_REGION }} || echo "âš ï¸ No recent logs found"
      
      - name: Verify bucket remediation
        id: verify
        run: |
          echo "ğŸ” Verifying if public bucket was remediated..."
          
          BUCKET="${{ needs.create-public-bucket.outputs.public_bucket }}"
          
          echo "Checking public access block settings:"
          PUBLIC_ACCESS=$(aws s3api get-public-access-block \
            --bucket $BUCKET \
            --region ${{ env.AWS_REGION }} 2>&1)
          
          echo "$PUBLIC_ACCESS"
          
          echo ""
          echo "Checking bucket policy:"
          BUCKET_POLICY=$(aws s3api get-bucket-policy --bucket $BUCKET --region ${{ env.AWS_REGION }} 2>&1) || echo "No bucket policy or access denied"
          echo "$BUCKET_POLICY"
          
          # Determine remediation status
          if echo "$PUBLIC_ACCESS" | grep -q "BlockPublicAcls.*true"; then
            echo ""
            echo "âœ… SUCCESS: Public access has been BLOCKED by Cloud Custodian!"
            echo "status=remediated" >> $GITHUB_OUTPUT
          elif echo "$BUCKET_POLICY" | grep -q "NoSuchBucketPolicy"; then
            echo ""
            echo "âœ… SUCCESS: Public bucket policy has been REMOVED by Cloud Custodian!"
            echo "status=remediated" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âš ï¸ WARNING: Bucket may still be public. Policy may need more time or different configuration."
            echo "status=still_public" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate test report
        run: |
          STATUS="${{ steps.verify.outputs.status }}"
          
          cat <<EOF > integration-test-report.md
          ## ğŸ§ª Integration Test Report - Automatic Detection
          
          **Test Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Lambda Function:** ${{ inputs.lambda_function_name }}
          **Monitoring Duration:** ${{ inputs.wait_time }} minutes
          
          ---
          
          ### Test Flow
          
          1. âœ… Created public S3 bucket: \`${{ needs.create-public-bucket.outputs.public_bucket }}\`
          2. â³ Waited for EventBridge to detect S3 events
          3. ğŸ“Š Monitored Lambda invocations via CloudWatch metrics
          4. ğŸ“‹ Checked Lambda execution logs
          5. ğŸ” Verified remediation status
          
          ---
          
          ### Results
          
          **Bucket:** \`${{ needs.create-public-bucket.outputs.public_bucket }}\`  
          **Created At:** ${{ needs.create-public-bucket.outputs.bucket_creation_time }}  
          **Status:** \`$STATUS\`
          
          $(if [ "$STATUS" == "remediated" ]; then
            cat <<RESULT
          
          #### âœ… TEST PASSED
          
          The integration test successfully verified:
          - âœ… EventBridge detected the S3 bucket creation event
          - âœ… Lambda function was triggered automatically
          - âœ… Cloud Custodian policy executed
          - âœ… Public access was blocked on the bucket
          
          **Automatic real-time remediation is working!**
          RESULT
          else
            cat <<RESULT
          
          #### âš ï¸ TEST INCONCLUSIVE
          
          The bucket is still public. Possible reasons:
          - â° EventBridge/CloudTrail events may be delayed
          - ğŸ”§ EventBridge rule pattern may not match S3 events
          - ğŸ“œ Policy may need adjustment for public bucket detection
          - â³ Lambda may need more time to execute
          
          **Check CloudWatch Logs for details.**
          RESULT
          fi)
          
          ---
          
          ### CloudWatch Logs
          
          View detailed execution logs:  
          \`/aws/lambda/${{ inputs.lambda_function_name }}\`
          
          ### AWS Console Links
          
          - [Lambda Function](https://console.aws.amazon.com/lambda/home?region=${{ env.AWS_REGION }}#/functions/${{ inputs.lambda_function_name }})
          - [CloudWatch Logs](https://console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#logsV2:log-groups/log-group//aws/lambda/${{ inputs.lambda_function_name }})
          - [EventBridge Rules](https://console.aws.amazon.com/events/home?region=${{ env.AWS_REGION }}#/rules)
          - [S3 Bucket](https://s3.console.aws.amazon.com/s3/buckets/${{ needs.create-public-bucket.outputs.public_bucket }})
          
          EOF
          
          cat integration-test-report.md
      
      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-report
          path: integration-test-report.md
          retention-days: 30

  # ======================================================================
  # Job 3: Cleanup Test Bucket
  # ======================================================================
  cleanup:
    name: Cleanup Test Bucket
    runs-on: ubuntu-latest
    needs: [create-public-bucket, monitor-execution]
    if: always() && inputs.cleanup
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActions-CloudCustodian-Role
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Delete test bucket
        run: |
          echo "ğŸ§¹ Cleaning up test S3 bucket..."
          
          BUCKET="${{ needs.create-public-bucket.outputs.public_bucket }}"
          
          # Delete bucket
          aws s3 rb s3://$BUCKET --force 2>&1 || echo "âš ï¸ Bucket already deleted or doesn't exist"
          
          echo "âœ… Test bucket cleanup complete"
      
      - name: Summary
        run: |
          echo "âœ… Integration test complete!"
          echo ""
          echo "Test bucket deleted: ${{ needs.create-public-bucket.outputs.public_bucket }}"
          echo "Lambda and EventBridge infrastructure remains deployed for continuous monitoring."
