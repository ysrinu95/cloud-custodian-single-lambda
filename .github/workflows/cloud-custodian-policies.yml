name: Cloud Custodian Demo & Policy Management

on:
  workflow_dispatch:
    inputs:
      operation_type:
        description: 'Type of operation to perform'
        required: true
        default: 'validate'
        type: choice
        options:
        # Policy Management
        - validate
        - deploy-updated
        - deploy-all
        - deploy-mailer
        - cleanup
        # Lambda Validation
        - validate-lambdas
        # Verification & Setup
        - verify-deployment
        - complete-setup-validation
        - deployment-report
        # Security Demos (Real AWS Service Integration)
        - demo-guardduty-real
        - demo-config-real
        - demo-securityhub-real
        - demo-macie-real
        - demo-access-analyzer-real
        - demo-s3-access-logs-real
        - demo-cloudtrail-security-real
        - demo-security-summary-real
        - demo-all-security-real
        # Resource Demos
        - demo-ec2-public
        - demo-rds-public
        - demo-ebs-unencrypted
        - demo-step-functions
        # Cleanup Operations
        - cleanup-demo-resources
        - cleanup-security-tests
        - cleanup-comprehensive
        - cleanup-scan
      target_accounts:
        description: 'Target accounts (comma-separated, or "all")'
        required: false
        default: 'engg'
        type: string
      dry_run:
        description: 'Run in dry-run mode (for policy operations)'
        required: false
        default: true
        type: boolean
      regions:
        description: 'Target regions (comma-separated)'
        required: false
        default: 'us-east-1'
        type: string
      monitoring_duration:
        description: 'Monitoring duration for security demos (minutes)'
        required: false
        default: '15'
        type: string
  
  push:
    branches: [main]
    paths:
      - 'c7n/policies/**'
      - 'c7n/scripts/**'
      - '.github/workflows/cloud-custodian-policies.yml'
  
  pull_request:
    paths:
      - 'c7n/policies/**'
      - 'c7n/scripts/**'
      - '.github/workflows/cloud-custodian-policies.yml'

env:
  AWS_REGION: 'us-east-1'
  PYTHON_VERSION: '3.11'

jobs:
  # ==============================================================================
  # Policy Validation and Management Jobs
  # ==============================================================================
  
  validate:
    name: 'Validate Cloud Custodian Policies'
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.operation_type == 'validate' ||
      github.event.inputs.operation_type == 'deploy-updated' ||
      github.event.inputs.operation_type == 'deploy-all' ||
      github.event.inputs.operation_type == 'deploy-mailer' ||
      github.event.inputs.operation_type == 'cleanup' ||
      github.event_name == 'push' ||
      github.event_name == 'pull_request'
    
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    
    outputs:
      validation-passed: ${{ steps.validation.outputs.passed }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for change detection
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-c7n-Validate-${{ github.run_number }}
      
      - name: Install Cloud Custodian and Dependencies
        run: |
          echo "ğŸ“¦ Installing Cloud Custodian ecosystem..."
          pip install --upgrade pip
          
          # Check if requirements.txt exists in expected locations
          if [ -f "c7n/requirements.txt" ]; then
            pip install -r c7n/requirements.txt
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            # Fallback: install core components
            echo "âš ï¸ Requirements file not found, installing core Cloud Custodian components..."
            pip install c7n c7n-org c7n-mailer c7n-left
          fi
          
          # Verify core installation
          echo "âœ… Verifying Cloud Custodian installation:"
          custodian version
          echo "âœ… Installation complete"
      
      - name: Install Additional Dependencies
        run: |
          echo "ğŸ”§ Installing additional dependencies..."
          sudo apt-get update && sudo apt-get install -y jq yq
          echo "âœ… Dependencies installed"
      
      - name: Validate Policy Syntax
        id: validation
        run: |
          echo "ğŸ” Validating Cloud Custodian policy syntax..."
          cd c7n
          
          validation_failed=false
          policy_count=0
          
          # Check for policy files specifically in c7n/policies directory
          POLICY_DIR="policies"
          echo "ğŸ“ Looking for policy files in: c7n/policies"
          
          if [ ! -d "$POLICY_DIR" ]; then
            echo "âŒ Policy directory not found: c7n/policies"
            echo "ğŸ’¡ Expected policy location: c7n/policies/"
            validation_failed=true
          elif ! ls "$POLICY_DIR"/*.yml 1> /dev/null 2>&1; then
            echo "âŒ No policy files (*.yml) found in: c7n/policies"
            echo "ğŸ’¡ Please ensure policy files are placed in c7n/policies/ directory"
            validation_failed=true
          else
            echo "âœ… Found policy files in: c7n/policies"
            
            # Validate each policy file in the policies directory
            for policy_file in "$POLICY_DIR"/*.yml; do
              if [ -f "$policy_file" ]; then
                policy_count=$((policy_count + 1))
                echo "  ğŸ“„ Validating: $policy_file"
                
                # Check Cloud Custodian schema
                if ! custodian validate "$policy_file"; then
                  echo "âŒ Cloud Custodian validation failed for: $policy_file"
                  validation_failed=true
                else
                  echo "âœ… Validation passed for: $policy_file"
                fi
              fi
            done
          fi
          
          echo "ğŸ“Š Validation Summary:"
          echo "  - Total policies validated: $policy_count"
          echo "  - Policy directory: c7n/policies/"
          
          if [ "$policy_count" -eq 0 ]; then
            echo "âŒ No policies found to validate in c7n/policies/"
            echo "ğŸ’¡ Please ensure policy files are placed in c7n/policies/ directory"
            validation_failed=true
          fi
          
          if [ "$validation_failed" = true ]; then
            echo "âŒ VALIDATION FAILED: One or more policies have validation errors"
            echo "ğŸš« All deployment operations are blocked until validation passes"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… All $policy_count policies validated successfully from c7n/policies/"
            echo "ğŸ¯ Deployment operations are authorized to proceed"
            echo "passed=true" >> $GITHUB_OUTPUT
          fi  # ==============================================================================
  # Verification and Setup Demo Jobs
  # ==============================================================================
  
  verify-deployment:
    name: 'Lambda Deployment Verification Demo'
    runs-on: ubuntu-latest
    if: github.event.inputs.operation_type == 'verify-deployment'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-verify-deployment-${{ github.run_number }}
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install c7n c7n-org c7n-mailer
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Run Lambda Deployment Verification
        run: |
          echo "ğŸ” Demo: Lambda Deployment Verification"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Checking deployment status of all Cloud Custodian Lambda functions"
          echo ""
          
          # Check if Cloud Custodian Lambda functions exist
          echo "ğŸ” Checking for Cloud Custodian Lambda functions..."
          LAMBDA_COUNT=$(aws lambda list-functions --region "${AWS_REGION}" \
            --query 'length(Functions[?starts_with(FunctionName, `custodian`)])' \
            --output text 2>/dev/null || echo "0")
          
          echo "ğŸ“Š Found $LAMBDA_COUNT Cloud Custodian Lambda functions"
          
          if [ "$LAMBDA_COUNT" -gt 0 ]; then
            echo "ğŸ“‹ Lambda Function Details:"
            aws lambda list-functions --region "${AWS_REGION}" \
              --query 'Functions[?starts_with(FunctionName, `custodian`)].{Name:FunctionName,Runtime:Runtime,LastModified:LastModified,State:State}' \
              --output table
          else
            echo "âš ï¸ No Cloud Custodian Lambda functions found"
            echo "ğŸ’¡ This might indicate:"
            echo "   - No policies have been deployed yet"
            echo "   - Policies are deployed in a different region"
            echo "   - Using a different naming convention"
          fi
          
          # Check CloudWatch Events rules
          echo ""
          echo "ğŸ” Checking CloudWatch Events rules..."
          RULES_COUNT=$(aws events list-rules --name-prefix custodian --region "${AWS_REGION}" \
            --query 'length(Rules)' --output text 2>/dev/null || echo "0")
          
          echo "ğŸ“Š Found $RULES_COUNT CloudWatch Events rules with 'custodian' prefix"
          
          if [ "$RULES_COUNT" -gt 0 ]; then
            echo "ğŸ“‹ CloudWatch Events Rules:"
            aws events list-rules --name-prefix custodian --region "${AWS_REGION}" \
              --query 'Rules[].{Name:Name,State:State,ScheduleExpression:ScheduleExpression}' \
              --output table
          fi
          
          echo ""
          echo "âœ… Lambda deployment verification completed"
          echo "ğŸ“Š Summary: $LAMBDA_COUNT Lambda functions, $RULES_COUNT CloudWatch rules"

  setup-validation:
    name: 'Complete Setup Validation Demo'
    runs-on: ubuntu-latest
    if: github.event.inputs.operation_type == 'complete-setup-validation'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-setup-validation-${{ github.run_number }}
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install c7n c7n-org c7n-mailer
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Run Complete Setup Validation
        run: |
          echo "âš™ï¸ Demo: Complete Setup Validation"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Comprehensive validation of Cloud Custodian deployment and dependencies"
          echo ""
          
          # Check GuardDuty
          echo "ğŸ” Checking GuardDuty service..."
          if GUARDDUTY_DETECTORS=$(aws guardduty list-detectors --region "${AWS_REGION}" \
            --query 'DetectorIds[0]' --output text 2>/dev/null); then
            if [[ "$GUARDDUTY_DETECTORS" != "None" ]] && [[ -n "$GUARDDUTY_DETECTORS" ]]; then
              echo "âœ… GuardDuty detector found: $GUARDDUTY_DETECTORS"
              
              # Check if detector is enabled
              DETECTOR_STATUS=$(aws guardduty get-detector --detector-id "$GUARDDUTY_DETECTORS" \
                --region "${AWS_REGION}" --query 'Status' --output text 2>/dev/null || echo "UNKNOWN")
              echo "   Status: $DETECTOR_STATUS"
            else
              echo "âŒ No GuardDuty detectors found"
            fi
          else
            echo "âŒ GuardDuty service check failed"
          fi
          
          echo ""
          echo "âœ… Complete setup validation finished"

  # ==============================================================================
  # Security Demo Jobs (Real AWS Service Integration)
  # ==============================================================================
  
  security-demo-guardduty:
    name: 'GuardDuty REAL Security Demo'
    runs-on: ubuntu-latest
    if: github.event.inputs.operation_type == 'demo-guardduty-real'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-guardduty-demo-${{ github.run_number }}
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install c7n c7n-org c7n-mailer
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Run GuardDuty REAL Security Demo
        run: |
          echo "ğŸ›¡ï¸ Demo: GuardDuty REAL Security Findings Detection"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Creating real vulnerable resources that GuardDuty will detect"
          echo ""
          
          # Use the comprehensive GuardDuty demo script
          cd c7n
          
          # Make the script executable
          chmod +x scripts/guardduty-security-demo.sh
          
          # Set environment variables for the demo
          export AWS_REGION="${{ env.AWS_REGION }}"
          export MONITORING_DURATION="${{ github.event.inputs.monitoring_duration || '15' }}"
          
          echo "ğŸ”§ Demo Configuration:"
          echo "   Region: $AWS_REGION"
          echo "   Monitoring Duration: $MONITORING_DURATION minutes"
          echo "   Account: ${{ github.event.inputs.target_accounts || 'engg' }}"
          echo ""
          
          # Check if GuardDuty is enabled first
          echo "ğŸ” Checking GuardDuty service status..."
          ./scripts/guardduty-security-demo.sh --check-only
          
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "ğŸ§ª DRY RUN MODE: Would create vulnerable resources"
            echo "   - EC2 instance with overly permissive security group"
            echo "   - Security group allowing SSH (22) from 0.0.0.0/0"
            echo "   - Security group allowing database ports from 0.0.0.0/0"
            echo "   - Instance with suspicious network activities"
            echo "   - Simulated cryptocurrency mining DNS queries"
            echo "   - Simulated malware C&C communication patterns"
            echo ""
            echo "âœ… Dry run completed - no actual resources created"
          else
            echo "ğŸš€ LIVE MODE: Creating real vulnerable resources"
            echo "âš ï¸ This will create actual AWS resources and generate GuardDuty findings"
            echo ""
            
            # Run the full GuardDuty demo
            ./scripts/guardduty-security-demo.sh --region "$AWS_REGION" --duration "$MONITORING_DURATION"
            
            echo ""
            echo "âœ… GuardDuty demo scenario completed"
          fi
          
          echo ""
          echo "ğŸ“Š Next Steps:"
          echo "ğŸ”— Monitor Progress:"
          echo "   â€¢ GuardDuty Console: https://$AWS_REGION.console.aws.amazon.com/guardduty/home?region=$AWS_REGION#/findings"
          echo "   â€¢ CloudWatch Logs: https://$AWS_REGION.console.aws.amazon.com/cloudwatch/home?region=$AWS_REGION#logsV2:log-groups"
          echo "   â€¢ EC2 Console: https://$AWS_REGION.console.aws.amazon.com/ec2/home?region=$AWS_REGION#Instances:"
          echo ""
          echo "ğŸ’¡ Expected GuardDuty Findings:"
          echo "   â€¢ UnauthorizedAPICall:EC2/MaliciousIPCaller"
          echo "   â€¢ CryptoCurrency:EC2/BitcoinTool.B!DNS"  
          echo "   â€¢ Trojan:EC2/DropPoint!DNS"
          echo "   â€¢ Recon:EC2/PortProbeUnprotectedPort"
          echo "   â€¢ Policy:IAMUser/RootCredentialUsage"
          echo ""
          echo "ğŸ”„ When findings are generated, Cloud Custodian will:"
          echo "   âœ… Send notifications to security team"
          echo "   âœ… Tag findings with compliance status"
          echo "   âœ… Queue email notifications via SQS"
          echo "   âœ… Trigger Slack alerts"

  security-demo-config:
    name: 'Config REAL Compliance Demo'
    runs-on: ubuntu-latest
    if: github.event.inputs.operation_type == 'demo-config-real'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-config-demo-${{ github.run_number }}
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install c7n c7n-org c7n-mailer
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Run Config REAL Compliance Demo
        run: |
          echo "ğŸ“‹ Demo: AWS Config REAL Compliance Violations Response"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Creating real compliance violations that Config will detect"
          echo ""
          
          # Use the comprehensive Config demo script
          cd c7n
          
          # Make the script executable
          chmod +x scripts/config-compliance-demo.sh
          
          # Set environment variables for the demo
          export AWS_REGION="${{ env.AWS_REGION }}"
          export MONITORING_DURATION="${{ github.event.inputs.monitoring_duration || '15' }}"
          
          echo "ğŸ”§ Demo Configuration:"
          echo "   Region: $AWS_REGION"
          echo "   Monitoring Duration: $MONITORING_DURATION minutes"
          echo "   Account: ${{ github.event.inputs.target_accounts || 'engg' }}"
          echo ""
          
          # Check if Config is enabled first
          echo "ğŸ” Checking AWS Config service status..."
          ./scripts/config-compliance-demo.sh --check-only
          
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "ğŸ§ª DRY RUN MODE: Would create compliance violations"
            echo "   - S3 bucket with public read access"
            echo "   - Unencrypted EBS volume"
            echo "   - Security group with overly permissive rules"
            echo "   - Config rules: s3-bucket-public-read-prohibited, encrypted-volumes"
            echo ""
            echo "âœ… Dry run completed - no actual resources created"
          else
            echo "ğŸš€ LIVE MODE: Creating real compliance violations"
            echo "âš ï¸ This will create actual AWS resources that violate Config rules"
            echo ""
            
            # Run the full Config demo
            ./scripts/config-compliance-demo.sh --region "$AWS_REGION" --duration "$MONITORING_DURATION"
            
            echo ""
            echo "âœ… Config compliance demo scenario completed"
          fi
          
          echo ""
          echo "ğŸ“Š Next Steps:"
          echo "ğŸ”— Monitor Progress:"
          echo "   â€¢ Config Console: https://$AWS_REGION.console.aws.amazon.com/config/home?region=$AWS_REGION#/rules"
          echo "   â€¢ CloudWatch Logs: https://$AWS_REGION.console.aws.amazon.com/cloudwatch/home?region=$AWS_REGION#logsV2:log-groups"
          echo "   â€¢ S3 Console: https://$AWS_REGION.console.aws.amazon.com/s3/home?region=$AWS_REGION"
          echo ""
          echo "ğŸ’¡ Expected Config Rule Violations:"
          echo "   â€¢ S3_BUCKET_PUBLIC_READ_PROHIBITED â†’ Public bucket access"
          echo "   â€¢ ENCRYPTED_VOLUMES â†’ Unencrypted EBS volume"
          echo "   â€¢ EC2_SECURITY_GROUP_ATTACHED_TO_ENI â†’ Overly permissive SG"
          echo ""
          echo "ğŸ”„ When violations are detected, Cloud Custodian will:"
          echo "   âœ… Invoke compliance tagger Lambda"
          echo "   âœ… Tag non-compliant resources"
          echo "   âœ… Send compliance team notifications"
          echo "   âœ… Queue email notifications via SQS"

  security-demo-securityhub:
    name: 'Security Hub REAL Security Demo'
    runs-on: ubuntu-latest
    if: github.event.inputs.operation_type == 'demo-securityhub-real'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-securityhub-demo-${{ github.run_number }}
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install c7n c7n-org c7n-mailer
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Run Security Hub REAL Security Demo
        run: |
          echo "ğŸ”’ Demo: Security Hub REAL Critical Findings Response"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Creating real security violations that Security Hub will detect"
          echo ""
          
          # Use the comprehensive Security Hub demo script
          cd c7n
          
          # Make the script executable
          chmod +x scripts/securityhub-demo.sh
          
          # Set environment variables for the demo
          export AWS_REGION="${{ env.AWS_REGION }}"
          export MONITORING_DURATION="${{ github.event.inputs.monitoring_duration || '15' }}"
          
          echo "ğŸ”§ Demo Configuration:"
          echo "   Region: $AWS_REGION"
          echo "   Monitoring Duration: $MONITORING_DURATION minutes"
          echo "   Account: ${{ github.event.inputs.target_accounts || 'engg' }}"
          echo ""
          
          # Check if Security Hub is enabled first
          echo "ğŸ” Checking Security Hub service status..."
          ./scripts/securityhub-demo.sh --check-only
          
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "ğŸ§ª DRY RUN MODE: Would create security violations"
            echo "   - Unencrypted public S3 bucket"
            echo "   - Security group with unrestricted access (SSH, HTTP, databases)"
            echo "   - IAM user without MFA"
            echo "   - AWS Foundational Security Standard violations"
            echo ""
            echo "âœ… Dry run completed - no actual resources created"
          else
            echo "ğŸš€ LIVE MODE: Creating real security violations"
            echo "âš ï¸ This will create actual AWS resources that violate Security Hub standards"
            echo ""
            
            # Run the full Security Hub demo
            ./scripts/securityhub-demo.sh --region "$AWS_REGION" --duration "$MONITORING_DURATION"
            
            echo ""
            echo "âœ… Security Hub demo scenario completed"
          fi
          
          echo ""
          echo "ğŸ“Š Next Steps:"
          echo "ğŸ”— Monitor Progress:"
          echo "   â€¢ Security Hub Console: https://$AWS_REGION.console.aws.amazon.com/securityhub/home?region=$AWS_REGION#/findings"
          echo "   â€¢ Standards Dashboard: https://$AWS_REGION.console.aws.amazon.com/securityhub/home?region=$AWS_REGION#/standards"
          echo "   â€¢ CloudWatch Logs: https://$AWS_REGION.console.aws.amazon.com/cloudwatch/home?region=$AWS_REGION#logsV2:log-groups"
          echo ""
          echo "ğŸ’¡ Expected Security Hub Findings:"
          echo "   â€¢ S3.4: S3 buckets should have server-side encryption enabled"
          echo "   â€¢ S3.1: S3 bucket public access should be restricted"
          echo "   â€¢ EC2.19: Security groups should not allow unrestricted access"
          echo "   â€¢ IAM.6: Hardware MFA should be enabled for root user"
          echo ""
          echo "ğŸ”„ When findings are generated, Cloud Custodian will:"
          echo "   âœ… Update finding workflow status"
          echo "   âœ… Set compliance status appropriately"
          echo "   âœ… Send notifications to security team"
          echo "   âœ… Queue Slack alerts for critical findings"

  security-demo-all:
    name: 'All Security Demos REAL Suite'
    runs-on: ubuntu-latest
    if: github.event.inputs.operation_type == 'demo-all-security-real'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-all-security-demo-${{ github.run_number }}
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install c7n c7n-org c7n-mailer
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Run All Security Demos REAL Test Suite
        run: |
          echo "ğŸš€ Cloud Custodian Security Demos - REAL Test Suite"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸ IMPORTANT: This runs REAL AWS security scenarios"
          echo "ğŸ“… Estimated Duration: 45-60 minutes for complete test suite"
          echo ""
          echo "âœ… All security demos completed successfully!"

  # ==============================================================================
  # Resource Demo Jobs  
  # ==============================================================================
  
  resource-demo-ec2:
    name: 'EC2 Public Instance Demo'
    runs-on: ubuntu-latest
    if: github.event.inputs.operation_type == 'demo-ec2-public'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-ec2-demo-${{ github.run_number }}
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install c7n c7n-org c7n-mailer
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Run EC2 Public Instance Demo
        run: |
          echo "ğŸ–¥ï¸ Demo: EC2 Public Instance Detection and Response"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Creating public EC2 instance for Cloud Custodian to detect"
          echo ""
          
          # Use the comprehensive EC2 demo script
          cd c7n
          
          # Make the script executable
          chmod +x scripts/ec2-public-demo.sh
          
          # Set environment variables for the demo
          export AWS_REGION="${{ env.AWS_REGION }}"
          export MONITORING_DURATION="${{ github.event.inputs.monitoring_duration || '15' }}"
          
          echo "ğŸ”§ Demo Configuration:"
          echo "   Region: $AWS_REGION"
          echo "   Monitoring Duration: $MONITORING_DURATION minutes"
          echo "   Account: ${{ github.event.inputs.target_accounts || 'engg' }}"
          echo ""
          
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "ğŸ§ª DRY RUN MODE: Would create public EC2 instances"
            echo "   - 3 EC2 instances with public IP addresses"
            echo "   - Security group allowing SSH/HTTP/HTTPS from 0.0.0.0/0"
            echo "   - Web server with demo page"
            echo "   - Mixed tagging scenarios (tagged, untagged, suspicious)"
            echo ""
            echo "âœ… Dry run completed - no actual resources created"
          else
            echo "ğŸš€ LIVE MODE: Creating real public EC2 instances"
            echo "âš ï¸ This will create actual AWS resources with public access"
            echo ""
            
            # Run the full EC2 demo
            ./scripts/ec2-public-demo.sh --region "$AWS_REGION" --duration "$MONITORING_DURATION"
            
            echo ""
            echo "âœ… EC2 public instance demo completed"
          fi
          
          echo ""
          echo "ğŸ“Š Next Steps:"
          echo "ğŸ”— Monitor Progress:"
          echo "   â€¢ EC2 Console: https://$AWS_REGION.console.aws.amazon.com/ec2/home?region=$AWS_REGION#Instances:"
          echo "   â€¢ CloudWatch Logs: https://$AWS_REGION.console.aws.amazon.com/cloudwatch/home?region=$AWS_REGION#logsV2:log-groups"
          echo "   â€¢ Lambda Console: https://$AWS_REGION.console.aws.amazon.com/lambda/home?region=$AWS_REGION#/functions"
          echo ""
          echo "ğŸ’¡ Expected Cloud Custodian Actions:"
          echo "   â€¢ ec2-public-instances: Tag public instances for review"
          echo "   â€¢ ec2-require-tags: Add missing required tags"
          echo "   â€¢ ec2-security-group-compliance: Review overly permissive SGs"
          echo "   â€¢ ec2-instance-lifecycle: Monitor and manage instance states"
          echo ""
          echo "ğŸ”„ When instances are detected, Cloud Custodian will:"
          echo "   âœ… Tag instances with compliance status"
          echo "   âœ… Send notifications to operations team"
          echo "   âœ… Log activities to CloudWatch"
          echo "   âœ… Queue email notifications via SQS"

  # ==============================================================================
  # Cleanup Demo Jobs
  # ==============================================================================
  
  cleanup-demo-resources:
    name: 'Cleanup Demo Resources'
    runs-on: ubuntu-latest
    if: github.event.inputs.operation_type == 'cleanup-demo-resources'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-cleanup-${{ github.run_number }}
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install c7n c7n-org c7n-mailer
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Run Demo Resource Cleanup
        run: |
          echo "ğŸ§¹ Demo: Cleanup Demo Resources"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Cleaning up resources created by Cloud Custodian demos"
          echo ""
          
          # Use the comprehensive cleanup script
          cd c7n
          
          # Make the script executable
          chmod +x scripts/cleanup-all-demos.sh
          
          # Set environment variables for cleanup
          export AWS_REGION="${{ env.AWS_REGION }}"
          
          echo "ğŸ”§ Cleanup Configuration:"
          echo "   Region: $AWS_REGION"
          echo "   Account: ${{ github.event.inputs.target_accounts || 'engg' }}"
          echo ""
          
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "ğŸ§ª DRY RUN MODE: Would clean up demo resources"
            echo "   - EC2 instances, security groups, key pairs, EBS volumes"
            echo "   - S3 buckets with 'custodian' and 'demo/test' in names"
            echo "   - IAM users and roles with 'demo/test' in names"
            echo "   - KMS keys with demo aliases"
            echo "   - SQS queues with 'custodian' prefix and 'demo/test'"
            echo "   - Macie classification jobs with 'demo/test' names"
            echo "   - CloudTrail trails with 'demo/test' names"
            echo ""
            echo "âœ… Dry run completed - no actual cleanup performed"
          else
            echo "ğŸš€ LIVE MODE: Cleaning up real demo resources"
            echo "âš ï¸ This will permanently delete demo resources!"
            echo ""
            
            # Run the comprehensive cleanup
            ./scripts/cleanup-all-demos.sh --region "$AWS_REGION"
            
            echo ""
            echo "âœ… Demo resource cleanup completed"
          fi
          
          echo ""
          echo "ğŸ“Š Resources Cleaned:"
          echo "   ğŸ–¥ï¸ EC2 instances (terminated)"
          echo "   ğŸ”’ Security groups (deleted)"
          echo "   ğŸ”‘ Key pairs (deleted)"
          echo "   ğŸ’¾ EBS volumes (deleted)"
          echo "   ğŸ“¦ S3 buckets (deleted)"
          echo "   ğŸ‘¤ IAM users/roles (deleted)"
          echo "   ğŸ” KMS keys (scheduled for deletion)"
          echo "   ğŸ“¬ SQS queues (deleted)"
          echo "   ğŸ” Macie jobs (cancelled)"
          echo "   ğŸ“Š CloudTrail trails (deleted)"
          echo ""
          echo "ğŸ” Verification:"
          echo "   â€¢ Check AWS consoles to confirm resource removal"
          echo "   â€¢ KMS keys have 7-day deletion waiting period"
          echo "   â€¢ CloudWatch logs are retained separately"

  # ==============================================================================
  # Policy Deployment Jobs
  # ==============================================================================

  deploy:
    name: 'Deploy Cloud Custodian Policies'
    runs-on: ubuntu-latest
    needs: [validate]
    if: |
      github.event_name == 'workflow_dispatch' && 
      github.event.inputs.operation_type != 'validate' &&
      contains(github.event.inputs.operation_type, 'deploy') &&
      needs.validate.outputs.validation-passed == 'true'
    
    permissions:
      id-token: write
      contents: read
    
    outputs:
      deployment-status: ${{ steps.deployment.outputs.status }}
      deployed-policies: ${{ steps.deployment.outputs.policies }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-c7n-Deploy-${{ github.run_number }}
      
      - name: Install Cloud Custodian and Dependencies
        run: |
          echo "ğŸ“¦ Installing Cloud Custodian ecosystem..."
          pip install --upgrade pip
          
          # Install core Cloud Custodian packages
          pip install 'c7n>=0.9.40'
          pip install c7n-org
          
          # Install mailer dependencies if needed
          if [[ "${{ github.event.inputs.operation_type }}" == "deploy-mailer" ]]; then
            echo "ğŸ“§ Installing mailer dependencies..."
            pip install --upgrade pip setuptools wheel
            
            # Use specific versions to avoid conflicts
            pip install --force-reinstall PyJWT==2.8.0
            pip install --force-reinstall cryptography==44.0.0
            pip install --force-reinstall requests==2.32.4
            pip install --force-reinstall decorator>=4.4.0
            pip install --force-reinstall boto3>=1.26.0
            pip install --force-reinstall botocore>=1.29.0
            pip install --force-reinstall jsonschema>=3.0.0
            pip install --force-reinstall python-dateutil>=2.8.0
            pip install --force-reinstall pyyaml>=5.4.0
            pip install --force-reinstall tabulate>=0.8.0
            pip install --force-reinstall c7n-mailer>=0.6.20
            
            echo "ğŸ” Verifying PyJWT installation..."
            python -c "import jwt; print(f'âœ… PyJWT {jwt.__version__} installed successfully')"
          fi
          
          # Install additional requirements if present
          if [ -f "c7n/requirements.txt" ]; then
            pip install -r c7n/requirements.txt
            echo "âœ… Installed additional requirements"
          fi
          
          # Install system dependencies
          sudo apt-get update && sudo apt-get install -y jq
          
          echo "âœ… Installation complete"
          custodian version
      
      - name: Make Scripts Executable
        run: |
          echo "ğŸ”§ Making c7n scripts executable..."
          chmod +x c7n/scripts/*.sh
          echo "âœ… Scripts are now executable"
      
      - name: Set Deployment Environment Variables
        run: |
          echo "ğŸ”§ Setting deployment environment variables..."
          
          # Set target accounts based on input
          TARGET_ACCOUNTS="${{ github.event.inputs.target_accounts }}"
          if [[ -z "$TARGET_ACCOUNTS" || "$TARGET_ACCOUNTS" == "" ]]; then
            TARGET_ACCOUNTS="engg"
          fi
          echo "TARGET_ACCOUNTS=$TARGET_ACCOUNTS" >> $GITHUB_ENV
          
          # Set regions
          REGIONS="${{ github.event.inputs.regions }}"
          if [[ -z "$REGIONS" || "$REGIONS" == "" ]]; then
            REGIONS="us-east-1"
          fi
          echo "REGIONS=$REGIONS" >> $GITHUB_ENV
          
          # Set dry-run mode
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          echo "DRY_RUN=$DRY_RUN" >> $GITHUB_ENV
          
          echo "âœ… Environment variables set:"
          echo "  - Target Accounts: $TARGET_ACCOUNTS"
          echo "  - Regions: $REGIONS"
          echo "  - Dry Run: $DRY_RUN"
      
      - name: Deploy Policies
        id: deployment
        run: |
          echo "ğŸš€ Deploying Cloud Custodian Policies"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Operation: ${{ github.event.inputs.operation_type }}"
          echo "Target Accounts: $TARGET_ACCOUNTS"
          echo "Regions: $REGIONS"
          echo "Dry Run: $DRY_RUN"
          echo ""
          
          cd c7n
          deployment_failed=false
          deployed_policies=""
          
          # Create output directory
          mkdir -p output logs
          
          case "${{ github.event.inputs.operation_type }}" in
            "deploy-all")
              echo "ğŸ¯ Running deploy-all operation..."
              if [[ "$DRY_RUN" == "true" ]]; then
                echo "ğŸ” Running in dry-run mode..."
                export DRY_RUN=true
              fi
              
              echo "ğŸ“‹ Executing: ./scripts/deploy-policies.sh"
              if ./scripts/deploy-policies.sh; then
                echo "âœ… Deploy-all completed successfully"
                deployed_policies=$(find policies/ -name "*.yml" -exec basename {} .yml \; | tr '\n' ',' | sed 's/,$//')
              else
                echo "âŒ Deploy-all failed"
                deployment_failed=true
              fi
              ;;
              
            "deploy-updated")
              echo "ğŸ”„ Running deploy-updated operation..."
              if [[ "$DRY_RUN" == "true" ]]; then
                echo "ğŸ” Running in dry-run mode..."
                export DRY_RUN=true
              fi
              
              echo "ğŸ“‹ Executing: ./scripts/deploy-updated-policies.sh"
              if ./scripts/deploy-updated-policies.sh; then
                echo "âœ… Deploy-updated completed successfully"
                # Try to detect which policies were updated
                deployed_policies=$(git diff --name-only HEAD~1 HEAD -- policies/ | xargs -I {} basename {} .yml | tr '\n' ',' | sed 's/,$//' || echo "updated-policies")
              else
                echo "âŒ Deploy-updated failed"
                deployment_failed=true
              fi
              ;;
              
            "deploy-mailer")
              echo "ğŸ“§ Running deploy-mailer operation..."
              
              # Apply PyJWT fix if needed
              echo "ğŸ”§ Applying PyJWT packaging fix..."
              if [[ -f "scripts/fix-core-deps.py" ]]; then
                python scripts/fix-core-deps.py || echo "Fix script not needed or already applied"
              fi
              
              echo "ğŸ“‹ Executing: ./scripts/deploy-mailer.sh"
              if ./scripts/deploy-mailer.sh; then
                echo "âœ… Deploy-mailer completed successfully"
                deployed_policies="mailer-service"
              else
                echo "âŒ Deploy-mailer failed"
                deployment_failed=true
              fi
              ;;
              
            "cleanup")
              echo "ğŸ§¹ Running cleanup operation..."
              echo "ğŸ“‹ Executing: ./scripts/clean-removed-policies.sh"
              if ./scripts/clean-removed-policies.sh; then
                echo "âœ… Cleanup completed successfully"
                deployed_policies="cleanup-completed"
              else
                echo "âŒ Cleanup failed"
                deployment_failed=true
              fi
              ;;
              
            *)
              echo "âŒ Unknown operation type: ${{ github.event.inputs.operation_type }}"
              deployment_failed=true
              ;;
          esac
          
          echo ""
          echo "ğŸ“Š Deployment Summary:"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Operation: ${{ github.event.inputs.operation_type }}"
          echo "Status: $([ "$deployment_failed" = true ] && echo "âŒ FAILED" || echo "âœ… SUCCESS")"
          echo "Deployed Policies: $deployed_policies"
          echo "Dry Run Mode: $DRY_RUN"
          echo ""
          
          # Set outputs
          echo "policies=$deployed_policies" >> $GITHUB_OUTPUT
          
          if [[ "$deployment_failed" == true ]]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ DEPLOYMENT FAILED"
            echo "ğŸ” Check logs and artifacts for detailed error information"
            exit 1
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… DEPLOYMENT COMPLETED SUCCESSFULLY"
            echo "ğŸ¯ All operations completed without errors"
          fi
      
      - name: Upload Deployment Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-output-${{ github.run_number }}
          path: |
            c7n/output/
            c7n/logs/
          retention-days: 30
      
      - name: Generate Deployment Report
        if: always()
        run: |
          echo "ğŸ“Š Cloud Custodian Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "====================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Operation**: ${{ github.event.inputs.operation_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ steps.deployment.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Target Accounts**: $TARGET_ACCOUNTS" >> $GITHUB_STEP_SUMMARY
          echo "**Regions**: $REGIONS" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run**: $DRY_RUN" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed Policies**: ${{ steps.deployment.outputs.policies }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ› ï¸ Deployment Scripts Used" >> $GITHUB_STEP_SUMMARY
          case "${{ github.event.inputs.operation_type }}" in
            "deploy-all")
              echo "- **Script**: \`c7n/scripts/deploy-policies.sh\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Purpose**: Deploy all Cloud Custodian policies" >> $GITHUB_STEP_SUMMARY
              ;;
            "deploy-updated")
              echo "- **Script**: \`c7n/scripts/deploy-updated-policies.sh\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Purpose**: Deploy only changed/updated policies" >> $GITHUB_STEP_SUMMARY
              ;;
            "deploy-mailer")
              echo "- **Script**: \`c7n/scripts/deploy-mailer.sh\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Purpose**: Deploy notification mailer service" >> $GITHUB_STEP_SUMMARY
              ;;
            "cleanup")
              echo "- **Script**: \`c7n/scripts/clean-removed-policies.sh\`" >> $GITHUB_STEP_SUMMARY
              echo "- **Purpose**: Clean up removed policy resources" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“ Resources" >> $GITHUB_STEP_SUMMARY
          echo "- **Policy Files**: \`c7n/policies/*.yml\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Scripts**: \`c7n/scripts/\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Configuration**: \`c7n/config/\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts**: Available in workflow artifacts" >> $GITHUB_STEP_SUMMARY

  validate-deployed-lambdas:
    name: 'Validate Deployed Lambda Functions'
    runs-on: ubuntu-latest
    needs: [deploy]
    if: |
      github.event_name == 'workflow_dispatch' && 
      contains(github.event.inputs.operation_type, 'deploy') &&
      needs.deploy.result == 'success'
    
    permissions:
      id-token: write
      contents: read
    
    outputs:
      lambda-validation-passed: ${{ steps.lambda-validation.outputs.passed }}
      lambda-count: ${{ steps.lambda-validation.outputs.lambda-count }}
      active-lambdas: ${{ steps.lambda-validation.outputs.active-lambdas }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-lambda-validation-${{ github.run_number }}
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install c7n c7n-org c7n-mailer
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Validate Deployed Lambda Functions
        id: lambda-validation
        run: |
          echo "ğŸ” Validating Cloud Custodian Lambda Functions in AWS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Checking deployed Lambda functions and their configurations..."
          echo ""
          
          # Set target regions based on input
          REGIONS="${{ github.event.inputs.regions }}"
          if [[ -z "$REGIONS" || "$REGIONS" == "" ]]; then
            REGIONS="us-east-1"
          fi
          echo "ğŸŒ Target regions: $REGIONS"
          
          # Convert comma-separated regions to array
          IFS=',' read -ra REGION_ARRAY <<< "$REGIONS"
          
          total_lambdas=0
          total_active=0
          total_errors=0
          all_lambda_details=""
          validation_failed=false
          
          for region in "${REGION_ARRAY[@]}"; do
            region=$(echo "$region" | xargs)  # Trim whitespace
            echo ""
            echo "ğŸ” Checking region: $region"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            
            # Get all Cloud Custodian Lambda functions
            echo "ğŸ“‹ Searching for Cloud Custodian Lambda functions..."
            LAMBDA_FUNCTIONS=$(aws lambda list-functions \
              --region "$region" \
              --query 'Functions[?starts_with(FunctionName, `custodian`)].[FunctionName,State,LastModified,Runtime,Timeout,MemorySize]' \
              --output text 2>/dev/null || echo "")
            
            if [[ -z "$LAMBDA_FUNCTIONS" ]]; then
              echo "âš ï¸ No Cloud Custodian Lambda functions found in region: $region"
              continue
            fi
            
            region_lambda_count=0
            region_active_count=0
            
            # Process each Lambda function
            while IFS=$'\t' read -r func_name state last_modified runtime timeout memory; do
              if [[ -n "$func_name" ]]; then
                region_lambda_count=$((region_lambda_count + 1))
                total_lambdas=$((total_lambdas + 1))
                
                echo ""
                echo "ğŸ“¦ Function: $func_name"
                echo "   ğŸ“Š State: $state"
                echo "   ğŸ•’ Last Modified: $last_modified"
                echo "   âš™ï¸ Runtime: $runtime"
                echo "   â±ï¸ Timeout: ${timeout}s"
                echo "   ğŸ’¾ Memory: ${memory}MB"
                
                # Check if function is active/ready
                if [[ "$state" == "Active" ]]; then
                  region_active_count=$((region_active_count + 1))
                  total_active=$((total_active + 1))
                  echo "   âœ… Status: Active and Ready"
                  
                  # Get additional function details
                  func_details=$(aws lambda get-function \
                    --function-name "$func_name" \
                    --region "$region" \
                    --query 'Configuration.[Description,Handler,Environment.Variables]' \
                    --output text 2>/dev/null || echo "")
                  
                  # Check CloudWatch Events rules for this function
                  related_rules=$(aws events list-rule-names-by-target \
                    --targets "Id=1,Arn=arn:aws:lambda:$region:*:function:$func_name" \
                    --region "$region" \
                    --query 'RuleNames' \
                    --output text 2>/dev/null || echo "")
                  
                  if [[ -n "$related_rules" && "$related_rules" != "None" ]]; then
                    echo "   ğŸ“… CloudWatch Rules: $related_rules"
                  fi
                  
                  # Test function configuration (basic validation)
                  config_check=$(aws lambda get-function-configuration \
                    --function-name "$func_name" \
                    --region "$region" \
                    --query '[State,StateReason]' \
                    --output text 2>/dev/null || echo "Error")
                  
                  if [[ "$config_check" == *"Error"* ]]; then
                    echo "   âš ï¸ Configuration check failed"
                    total_errors=$((total_errors + 1))
                  else
                    echo "   âœ… Configuration: Valid"
                  fi
                  
                elif [[ "$state" == "Pending" ]]; then
                  echo "   ğŸŸ¡ Status: Pending (deployment in progress)"
                elif [[ "$state" == "Failed" ]]; then
                  echo "   âŒ Status: Failed"
                  total_errors=$((total_errors + 1))
                  validation_failed=true
                else
                  echo "   âš ï¸ Status: $state (unknown state)"
                fi
                
                # Store function details for summary
                all_lambda_details="${all_lambda_details}${region}:${func_name}:${state};"
              fi
            done <<< "$LAMBDA_FUNCTIONS"
            
            echo ""
            echo "ğŸ“Š Region Summary ($region):"
            echo "   - Lambda functions found: $region_lambda_count"
            echo "   - Active functions: $region_active_count"
            echo ""
          done
          
          # Check for CloudWatch Events rules
          echo "ğŸ” Checking CloudWatch Events Rules..."
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          for region in "${REGION_ARRAY[@]}"; do
            region=$(echo "$region" | xargs)
            
            rules_count=$(aws events list-rules \
              --name-prefix custodian \
              --region "$region" \
              --query 'length(Rules)' \
              --output text 2>/dev/null || echo "0")
            
            if [[ "$rules_count" -gt 0 ]]; then
              echo "âœ… Found $rules_count CloudWatch Events rules in $region"
              
              # List the rules
              aws events list-rules \
                --name-prefix custodian \
                --region "$region" \
                --query 'Rules[].{Name:Name,State:State,ScheduleExpression:ScheduleExpression}' \
                --output table 2>/dev/null || echo "Error listing rules"
            else
              echo "âš ï¸ No CloudWatch Events rules found in $region"
            fi
          done
          
          echo ""
          echo "ğŸ“Š FINAL VALIDATION SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ Regions checked: $(echo "$REGIONS" | tr ',' ' ')"
          echo "ğŸ“¦ Total Lambda functions found: $total_lambdas"
          echo "âœ… Active Lambda functions: $total_active"
          echo "âŒ Failed/Error functions: $total_errors"
          echo ""
          
          # Set outputs
          echo "lambda-count=$total_lambdas" >> $GITHUB_OUTPUT
          echo "active-lambdas=$total_active" >> $GITHUB_OUTPUT
          
          # Determine validation result
          if [[ "$total_lambdas" -eq 0 ]]; then
            echo "âš ï¸ VALIDATION WARNING: No Cloud Custodian Lambda functions found"
            echo "ğŸ’¡ This might indicate:"
            echo "   - Policies are not configured for Lambda deployment (mode: periodic/cloudtrail)"
            echo "   - Deployment failed silently"
            echo "   - Functions are deployed with different naming convention"
            echo "   - Wrong region specified"
            echo ""
            echo "ğŸ” Recommendation: Check deployment logs and ensure policies have appropriate modes"
            echo "passed=warning" >> $GITHUB_OUTPUT
          elif [[ "$validation_failed" == true || "$total_errors" -gt 0 ]]; then
            echo "âŒ VALIDATION FAILED: Some Lambda functions have errors"
            echo "ğŸš« Deployment validation unsuccessful"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          elif [[ "$total_active" -eq "$total_lambdas" && "$total_lambdas" -gt 0 ]]; then
            echo "âœ… VALIDATION PASSED: All Lambda functions are active and healthy"
            echo "ğŸ¯ Deployment validation successful"
            echo "ğŸ“ˆ Success rate: 100% ($total_active/$total_lambdas)"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ VALIDATION PARTIAL: Some functions may still be deploying"
            echo "ğŸ“Š Active functions: $total_active/$total_lambdas"
            echo "ğŸ’¡ Some functions might still be in 'Pending' state"
            echo "passed=partial" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "âœ… Lambda function validation completed"

  # ==============================================================================
  # Standalone Lambda Validation Job (can be triggered independently)
  # ==============================================================================
  
  validate-lambdas:
    name: 'Validate Lambda Functions (Standalone)'
    runs-on: ubuntu-latest
    if: github.event.inputs.operation_type == 'validate-lambdas'
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-standalone-lambda-validation-${{ github.run_number }}
      
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install c7n c7n-org c7n-mailer
          sudo apt-get update && sudo apt-get install -y jq
      
      - name: Standalone Lambda Function Validation
        run: |
          echo "ğŸ” Standalone Cloud Custodian Lambda Function Validation"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Comprehensive check of all deployed Lambda functions and configurations"
          echo ""
          
          # Set target regions based on input
          REGIONS="${{ github.event.inputs.regions }}"
          if [[ -z "$REGIONS" || "$REGIONS" == "" ]]; then
            REGIONS="us-east-1"
          fi
          echo "ğŸŒ Target regions: $REGIONS"
          
          # Set target accounts based on input
          TARGET_ACCOUNTS="${{ github.event.inputs.target_accounts }}"
          if [[ -z "$TARGET_ACCOUNTS" || "$TARGET_ACCOUNTS" == "" ]]; then
            TARGET_ACCOUNTS="engg"
          fi
          echo "ğŸ¢ Target accounts: $TARGET_ACCOUNTS"
          echo ""
          
          # Convert comma-separated regions to array
          IFS=',' read -ra REGION_ARRAY <<< "$REGIONS"
          
          total_lambdas=0
          total_active=0
          total_errors=0
          validation_failed=false
          
          for region in "${REGION_ARRAY[@]}"; do
            region=$(echo "$region" | xargs)  # Trim whitespace
            echo ""
            echo "ğŸ” Validating region: $region"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Get all Cloud Custodian Lambda functions with detailed info
            echo "ğŸ“‹ Discovering Cloud Custodian Lambda functions..."
            LAMBDA_FUNCTIONS=$(aws lambda list-functions \
              --region "$region" \
              --query 'Functions[?starts_with(FunctionName, `custodian`)].[FunctionName,State,LastModified,Runtime,Timeout,MemorySize,CodeSize,Description]' \
              --output text 2>/dev/null || echo "")
            
            if [[ -z "$LAMBDA_FUNCTIONS" ]]; then
              echo "âš ï¸ No Cloud Custodian Lambda functions found in region: $region"
              echo "ğŸ’¡ Expected function name pattern: custodian-*"
              continue
            fi
            
            region_lambda_count=0
            region_active_count=0
            region_error_count=0
            
            # Process each Lambda function with detailed validation
            while IFS=$'\t' read -r func_name state last_modified runtime timeout memory code_size description; do
              if [[ -n "$func_name" ]]; then
                region_lambda_count=$((region_lambda_count + 1))
                total_lambdas=$((total_lambdas + 1))
                
                echo ""
                echo "ğŸ“¦ Function: $func_name"
                echo "   ğŸ“Š State: $state"
                echo "   ğŸ•’ Last Modified: $last_modified"
                echo "   âš™ï¸ Runtime: $runtime"
                echo "   â±ï¸ Timeout: ${timeout}s"
                echo "   ğŸ’¾ Memory: ${memory}MB"
                echo "   ğŸ“¦ Code Size: ${code_size} bytes"
                echo "   ğŸ“ Description: $description"
                
                # Detailed function configuration validation
                echo "   ğŸ” Running detailed validation..."
                
                # 1. Check function state and configuration
                func_config=$(aws lambda get-function-configuration \
                  --function-name "$func_name" \
                  --region "$region" \
                  --query '{State:State,StateReason:StateReason,LastUpdateStatus:LastUpdateStatus,PackageType:PackageType}' \
                  --output json 2>/dev/null || echo "{}")
                
                if [[ "$func_config" != "{}" ]]; then
                  func_state=$(echo "$func_config" | jq -r '.State // "Unknown"')
                  state_reason=$(echo "$func_config" | jq -r '.StateReason // "None"')
                  update_status=$(echo "$func_config" | jq -r '.LastUpdateStatus // "Unknown"')
                  package_type=$(echo "$func_config" | jq -r '.PackageType // "Unknown"')
                  
                  echo "   â”œâ”€ Function State: $func_state"
                  echo "   â”œâ”€ State Reason: $state_reason"
                  echo "   â”œâ”€ Last Update Status: $update_status"
                  echo "   â””â”€ Package Type: $package_type"
                  
                  if [[ "$func_state" == "Active" && "$update_status" == "Successful" ]]; then
                    region_active_count=$((region_active_count + 1))
                    total_active=$((total_active + 1))
                    echo "   âœ… Status: Healthy and Active"
                  else
                    region_error_count=$((region_error_count + 1))
                    total_errors=$((total_errors + 1))
                    validation_failed=true
                    echo "   âŒ Status: Issues detected"
                  fi
                else
                  echo "   âŒ Failed to get function configuration"
                  region_error_count=$((region_error_count + 1))
                  total_errors=$((total_errors + 1))
                  validation_failed=true
                fi
                
                # 2. Check CloudWatch Events/EventBridge rules
                echo "   ğŸ” Checking associated CloudWatch Events..."
                related_rules=$(aws events list-targets-by-rule \
                  --region "$region" \
                  --query "Targets[?contains(Arn, '$func_name')].Id" \
                  --output text 2>/dev/null || echo "")
                
                if [[ -n "$related_rules" && "$related_rules" != "None" ]]; then
                  echo "   â”œâ”€ ğŸ“… Associated CloudWatch Rules: Found"
                  
                  # Get rule details
                  rules_for_function=$(aws events list-rules \
                    --region "$region" \
                    --query "Rules[?State=='ENABLED'].Name" \
                    --output text 2>/dev/null || echo "")
                  
                  rule_count=$(echo "$rules_for_function" | wc -w)
                  echo "   â””â”€ ğŸ“Š Active Rules Count: $rule_count"
                else
                  echo "   â””â”€ âš ï¸ No CloudWatch Events rules found"
                fi
                
                # 3. Check recent executions and errors
                echo "   ğŸ” Checking recent executions..."
                
                # Get CloudWatch logs for the function (last 24 hours)
                log_group="/aws/lambda/$func_name"
                
                recent_errors=$(aws logs filter-log-events \
                  --log-group-name "$log_group" \
                  --region "$region" \
                  --start-time $(( $(date +%s) * 1000 - 86400000 )) \
                  --filter-pattern "ERROR" \
                  --query 'length(events)' \
                  --output text 2>/dev/null || echo "0")
                
                if [[ "$recent_errors" -gt 0 ]]; then
                  echo "   â”œâ”€ âš ï¸ Recent Errors: $recent_errors (last 24h)"
                else
                  echo "   â”œâ”€ âœ… Recent Errors: None (last 24h)"
                fi
                
                # 4. Check function permissions and policies
                echo "   â”œâ”€ ğŸ” Checking IAM permissions..."
                
                execution_role=$(aws lambda get-function \
                  --function-name "$func_name" \
                  --region "$region" \
                  --query 'Configuration.Role' \
                  --output text 2>/dev/null || echo "")
                
                if [[ -n "$execution_role" && "$execution_role" != "None" ]]; then
                  role_name=$(basename "$execution_role")
                  echo "   â”œâ”€ ğŸ“‹ Execution Role: $role_name"
                  
                  # Check if role exists and is accessible
                  role_check=$(aws iam get-role --role-name "$role_name" --query 'Role.RoleName' --output text 2>/dev/null || echo "Error")
                  if [[ "$role_check" != "Error" ]]; then
                    echo "   â””â”€ âœ… IAM Role: Accessible"
                  else
                    echo "   â””â”€ âŒ IAM Role: Access issues"
                  fi
                else
                  echo "   â””â”€ âŒ Execution Role: Not found"
                fi
                
                echo ""
              fi
            done <<< "$LAMBDA_FUNCTIONS"
            
            echo "ğŸ“Š Region Summary ($region):"
            echo "   â”œâ”€ Total Lambda functions: $region_lambda_count"
            echo "   â”œâ”€ Active & Healthy: $region_active_count"
            echo "   â””â”€ With Issues: $region_error_count"
            echo ""
          done
          
          # Overall CloudWatch Events validation
          echo ""
          echo "ğŸ” Overall CloudWatch Events Validation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          total_rules=0
          for region in "${REGION_ARRAY[@]}"; do
            region=$(echo "$region" | xargs)
            
            echo "ğŸ“ Region: $region"
            
            rules=$(aws events list-rules \
              --name-prefix custodian \
              --region "$region" \
              --query 'Rules[].{Name:Name,State:State,ScheduleExpression:ScheduleExpression,EventPattern:EventPattern}' \
              --output json 2>/dev/null || echo "[]")
            
            region_rules_count=$(echo "$rules" | jq 'length')
            total_rules=$((total_rules + region_rules_count))
            
            if [[ "$region_rules_count" -gt 0 ]]; then
              echo "   âœ… CloudWatch Rules: $region_rules_count found"
              
              # Show rule details
              echo "$rules" | jq -r '.[] | "   â”œâ”€ \(.Name): \(.State) \(if .ScheduleExpression then "[\(.ScheduleExpression)]" else "[Event-driven]" end)"'
            else
              echo "   âš ï¸ CloudWatch Rules: None found"
            fi
            echo ""
          done
          
          # Final validation summary
          echo ""
          echo "ğŸ“Š COMPREHENSIVE VALIDATION SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸŒ Regions validated: $(echo "$REGIONS" | tr ',' ' ')"
          echo "ğŸ¢ Target accounts: $TARGET_ACCOUNTS"
          echo "ğŸ“¦ Total Lambda functions: $total_lambdas"
          echo "âœ… Active & Healthy functions: $total_active"
          echo "âŒ Functions with issues: $total_errors"
          echo "ğŸ“… Total CloudWatch rules: $total_rules"
          echo ""
          
          # Calculate success rate
          if [[ "$total_lambdas" -gt 0 ]]; then
            success_rate=$(( (total_active * 100) / total_lambdas ))
            echo "ğŸ“ˆ Success Rate: $success_rate% ($total_active/$total_lambdas)"
          else
            success_rate=0
            echo "ğŸ“ˆ Success Rate: N/A (no functions found)"
          fi
          echo ""
          
          # Final determination
          if [[ "$total_lambdas" -eq 0 ]]; then
            echo "âš ï¸ VALIDATION RESULT: NO FUNCTIONS FOUND"
            echo "ğŸ’¡ Possible reasons:"
            echo "   â€¢ No policies deployed with Lambda mode (periodic/cloudtrail)"
            echo "   â€¢ Different function naming convention used"
            echo "   â€¢ Wrong region or account specified"
            echo "   â€¢ Deployment not yet completed"
          elif [[ "$validation_failed" == true || "$total_errors" -gt 0 ]]; then
            echo "âŒ VALIDATION RESULT: FAILED"
            echo "ğŸš« Some Lambda functions have critical issues"
            echo "ğŸ”§ Recommendation: Review function logs and configurations"
            exit 1
          elif [[ "$success_rate" -eq 100 && "$total_lambdas" -gt 0 ]]; then
            echo "âœ… VALIDATION RESULT: PASSED"
            echo "ğŸ¯ All Lambda functions are healthy and operational"
            echo "ğŸš€ Cloud Custodian deployment is fully functional"
          elif [[ "$success_rate" -ge 80 ]]; then
            echo "âš ï¸ VALIDATION RESULT: MOSTLY SUCCESSFUL"
            echo "ğŸ“Š Most functions are working but some issues detected"
            echo "ğŸ”§ Recommendation: Review functions with issues"
          else
            echo "âŒ VALIDATION RESULT: MULTIPLE ISSUES"
            echo "ğŸš« Significant number of functions have problems"
            echo "ğŸ”§ Recommendation: Review deployment and function configurations"
            exit 1
          fi
          
          echo ""
          echo "âœ… Standalone Lambda validation completed"

  notify:
    name: 'Demo Completion Notification'
    runs-on: ubuntu-latest
    needs: [validate, deploy, validate-deployed-lambdas, validate-lambdas, verify-deployment, setup-validation, security-demo-guardduty, security-demo-config, security-demo-securityhub, security-demo-all, resource-demo-ec2, cleanup-demo-resources]
    if: always() && github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Generate Final Summary
        run: |
          echo "ğŸ¯ Cloud Custodian Demo & Policy Management Complete" >> $GITHUB_STEP_SUMMARY
          echo "====================================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Operation**: ${{ github.event.inputs.operation_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add Lambda validation results if deployment occurred
          if [[ "${{ contains(github.event.inputs.operation_type, 'deploy') }}" == "true" ]]; then
            echo "## ğŸ” Lambda Validation Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            lambda_validation_result="${{ needs.validate-deployed-lambdas.outputs.lambda-validation-passed }}"
            lambda_count="${{ needs.validate-deployed-lambdas.outputs.lambda-count }}"
            active_lambdas="${{ needs.validate-deployed-lambdas.outputs.active-lambdas }}"
            
            if [[ "$lambda_validation_result" == "true" ]]; then
              echo "âœ… **Lambda Validation**: PASSED" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ“¦ **Total Functions**: $lambda_count" >> $GITHUB_STEP_SUMMARY
              echo "ğŸŸ¢ **Active Functions**: $active_lambdas" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ“ˆ **Success Rate**: 100%" >> $GITHUB_STEP_SUMMARY
            elif [[ "$lambda_validation_result" == "partial" ]]; then
              echo "âš ï¸ **Lambda Validation**: PARTIAL SUCCESS" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ“¦ **Total Functions**: $lambda_count" >> $GITHUB_STEP_SUMMARY
              echo "ğŸŸ¡ **Active Functions**: $active_lambdas" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ’¡ **Note**: Some functions may still be deploying" >> $GITHUB_STEP_SUMMARY
            elif [[ "$lambda_validation_result" == "warning" ]]; then
              echo "âš ï¸ **Lambda Validation**: WARNING" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ“¦ **Total Functions**: $lambda_count" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ’¡ **Note**: No Lambda functions found - policies may not be configured for Lambda deployment" >> $GITHUB_STEP_SUMMARY
            elif [[ "$lambda_validation_result" == "false" ]]; then
              echo "âŒ **Lambda Validation**: FAILED" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ“¦ **Total Functions**: $lambda_count" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ”´ **Active Functions**: $active_lambdas" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Status**: Some Lambda functions have errors" >> $GITHUB_STEP_SUMMARY
            else
              echo "â“ **Lambda Validation**: UNKNOWN" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ’¡ **Note**: Lambda validation may have been skipped" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Detect Changed Policies
        id: change-detection
        if: github.event_name == 'pull_request' || github.event_name == 'push'
        run: |
          echo "ğŸ” Detecting changed policies..."
          cd c7n
          
          # Set up git refs for comparison
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin main
            base_ref="origin/main"
            head_ref="HEAD"
            echo "ğŸ“‹ Comparing PR changes: $base_ref â†’ $head_ref"
          else
            # For push events, compare with previous commit
            base_ref="HEAD~1"
            head_ref="HEAD"
            echo "ğŸ“‹ Comparing push changes: $base_ref â†’ $head_ref"
          fi
          
          # Check for changed policy files specifically in c7n/policies directory
          changed_files=$(git diff --name-only "$base_ref" "$head_ref" -- policies/ 2>/dev/null || echo "")
          echo "ğŸ“„ Changed policy files in c7n/policies/: $changed_files"
          
          changed_policies=""
          
          # Use c7n-policystream if available for more accurate detection
          if command -v c7n-policystream >/dev/null 2>&1; then
            echo "ğŸ” Using c7n-policystream for advanced change detection..."
            policy_changes=$(c7n-policystream diff --source "$base_ref" --target "$head_ref" 2>/dev/null || echo "")
            if [ -n "$policy_changes" ]; then
              changed_policies=$(echo "$policy_changes" | yq -r '.policies[]?.name' 2>/dev/null || echo "")
            fi
          fi
          
          # Fallback: analyze changed files directly
          if [ -z "$changed_policies" ] && [ -n "$changed_files" ]; then
            echo "ğŸ” Fallback: Analyzing changed files directly..."
            for file in $changed_files; do
              if [[ "$file" == *.yml ]] && [[ -f "$file" ]]; then
                echo "  ğŸ“„ Analyzing: $file"
                file_policies=$(yq -r '.policies[]?.name' "$file" 2>/dev/null || echo "")
                if [ -n "$file_policies" ]; then
                  changed_policies="$changed_policies $file_policies"
                  echo "    Found policies: $file_policies"
                fi
              fi
            done
          fi
          
          # Clean up the policy list (remove duplicates and empty entries)
          if [ -n "$changed_policies" ]; then
            changed_policies=$(echo "$changed_policies" | tr ' ' '\n' | sort -u | tr '\n' ' ' | sed 's/[[:space:]]*$//')
          fi
          
          echo ""
          echo "ğŸ“Š Change Detection Summary:"
          echo "============================"
          echo "  Changed files: $(echo "$changed_files" | wc -w)"
          echo "  Changed policies: $(echo "$changed_policies" | wc -w)"
          echo "  Policy names: $changed_policies"
          echo ""
          
          if [ -n "$changed_policies" ]; then
            echo "âœ… Policy changes detected - dry-run will be performed"
          else
            echo "ğŸ“ No policy changes detected - skipping dry-run"
          fi
          
          echo "policies=$changed_policies" >> $GITHUB_OUTPUT
      
      - name: Dry Run Changed Policies
        if: steps.change-detection.outputs.policies != ''
        run: |
          echo "ğŸ§ª Running dry-run on changed policies..."
          cd c7n
          
          mkdir -p ../artifacts/validation-dryrun
          
          # Create a single-account config for validation using development account
          cat > validation-accounts.yml << EOF
          accounts:
          - account_id: '172327596604'
            name: engg
            regions:
            - us-east-1
            role: arn:aws:iam::172327596604:role/CloudCustodian-ExecutionRole
            vars:
              environment: engg
          EOF
          
          changed_policies="${{ steps.change-detection.outputs.policies }}"
          policy_count=0
          tested_count=0
          
          echo "ğŸ“‹ Changed policies detected: $changed_policies"
          echo ""
          
          for policy in $changed_policies; do
            if [ -n "$policy" ]; then
              policy_count=$((policy_count + 1))
              echo "ğŸ” Testing policy: $policy"
              
              # Find which file contains this policy
              found_file=""
              for policy_file in policies/*.yml; do
                if grep -q "name: $policy" "$policy_file"; then
                  found_file="$policy_file"
                  break
                fi
              done
              
              if [ -n "$found_file" ]; then
                echo "  ğŸ“„ Found in: $found_file"
                echo "  ğŸš€ Running dry-run against account: engg"
                
                if c7n-org run -c validation-accounts.yml -u "$found_file" -s ../artifacts/validation-dryrun -p "$policy" --dryrun; then
                  echo "  âœ… Dry-run completed successfully for: $policy"
                  tested_count=$((tested_count + 1))
                else
                  echo "  âš ï¸ Dry-run encountered issues for: $policy (check artifacts for details)"
                  # Continue with other policies even if one fails
                fi
              else
                echo "  âŒ Policy file not found for: $policy"
              fi
              echo ""
            fi
          done
          
          echo "ğŸ“Š Changed Policy Dry-Run Summary:"
          echo "================================="
          echo "  Changed policies detected: $policy_count"
          echo "  Successfully tested: $tested_count"
          echo ""
          
          if [ "$tested_count" -eq "$policy_count" ] && [ "$policy_count" -gt 0 ]; then
            echo "âœ… All changed policies completed dry-run testing"
          elif [ "$policy_count" -gt 0 ]; then
            echo "âš ï¸ Some changed policies had issues during dry-run (see artifacts for details)"
          else
            echo "ğŸ“ No changed policies to test"
          fi
          
          echo "âœ… Dry-run validation completed"
      
      - name: Upload Validation Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: policy-validation-${{ github.run_number }}
          path: artifacts/validation-dryrun/
          retention-days: 30
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const validationPassed = '${{ needs.validate.outputs.validation-passed }}' === 'true';
            const changedPolicies = '${{ steps.change-detection.outputs.policies }}';
            
            let comment = `## ğŸ›¡ï¸ Cloud Custodian Policy Validation\n\n`;
            
            if (validationPassed) {
              comment += `âœ… **Validation Result**: All policies passed syntax validation\n\n`;
            } else {
              comment += `âŒ **Validation Result**: Policy validation failed\n\n`;
            }
            
            if (changedPolicies.trim()) {
              const policyList = changedPolicies.trim().split(' ').filter(p => p.length > 0);
              comment += `**Changed Policies** (${policyList.length} detected):\n`;
              policyList.forEach(policy => {
                comment += `- \`${policy}\`\n`;
              });
              comment += `\nğŸ§ª **Dry Run**: Completed for changed policies against \`engg\` account\n`;
              comment += `ğŸ“Š **Coverage**: Only changed policies tested (efficient approach)\n\n`;
            } else {
              comment += `**Changed Policies**: None detected\n\n`;
            }
            
            comment += `**Artifacts**: Download validation artifacts to review detailed results\n`;
            comment += `**Test Account**: \`engg\` (172327596604)\n`;
            comment += `**Next Steps**: ${validationPassed ? 'âœ… Ready for deployment' : 'âŒ Fix validation errors before proceeding'}\n\n`;
            
            if (changedPolicies.trim()) {
              comment += `### ğŸ” What was tested:\n`;
              comment += `- **Syntax Validation**: All policy files checked\n`;
              comment += `- **Schema Validation**: Cloud Custodian schema compliance\n`;
              comment += `- **Dry Run**: Changed policies tested against AWS resources\n`;
              comment += `- **Account**: engg environment for safe testing\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });