name: Run Cloud Custodian Periodic Policies

on:
  schedule:
    # Run daily at 6 AM UTC (all policies)
    - cron: '0 6 * * *'
    # Run every 6 hours for critical policies (S3, IAM, Security Hub)
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      account_id:
        description: 'Member Account ID to scan'
        required: false
        type: string
        default: '813185901390'
      policy_file:
        description: 'Specific policy file to run (e.g., s3.yml, iam.yml, all)'
        required: false
        type: string
        default: 'all'
      dry_run:
        description: 'Dry run mode (skip actions)'
        required: false
        type: boolean
        default: false
      regions:
        description: 'AWS regions to scan (comma-separated, or "all")'
        required: false
        type: string
        default: 'us-east-1'

env:
  AWS_REGION: us-east-1
  CENTRAL_ACCOUNT_ID: "172327596604"
  MEMBER_ACCOUNT_ID: "813185901390"
  PYTHON_VERSION: "3.12"

permissions:
  id-token: write
  contents: read

jobs:
  run-periodic-policies:
    name: Run Periodic Policies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Cloud Custodian
        run: |
          python -m pip install --upgrade pip
          pip install c7n c7n-mailer

      - name: Configure AWS credentials (Central Account)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.CENTRAL_ACCOUNT_ID }}:role/GitHubActions-CloudCustodian-Role
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine target account
        id: account
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.account_id }}" ]; then
            echo "account_id=${{ github.event.inputs.account_id }}" >> $GITHUB_OUTPUT
          else
            echo "account_id=${{ env.MEMBER_ACCOUNT_ID }}" >> $GITHUB_OUTPUT
          fi

      - name: Assume member account role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ steps.account.outputs.account_id }}:role/CloudCustodianExecutionRole
          role-chaining: true
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS credentials
        run: |
          echo "Current AWS identity:"
          aws sts get-caller-identity
          echo "Account ID: ${{ steps.account.outputs.account_id }}"

      - name: Run periodic policies
        run: |
          ACCOUNT_ID="${{ steps.account.outputs.account_id }}"
          POLICY_FILE="${{ github.event.inputs.policy_file }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          REGIONS="${{ github.event.inputs.regions || 'us-east-1' }}"
          
          cd c7n
          mkdir -p output/periodic
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "  Cloud Custodian Periodic Policies Execution"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Account: $ACCOUNT_ID"
          echo "Regions: $REGIONS"
          echo "Dry Run: $DRY_RUN"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo ""
          
          # Determine which policies to run based on schedule or input
          if [ "${{ github.event_name }}" == "schedule" ] && [ "${{ github.event.schedule }}" == "0 */6 * * *" ]; then
            # Every 6 hours: run critical policies only
            POLICY_FILES="policies/periodic/s3.yml policies/periodic/iam.yml policies/periodic/securityhub.yml"
            echo "‚è∞ Scheduled run (6-hourly): Critical policies only"
          elif [ -n "$POLICY_FILE" ] && [ "$POLICY_FILE" != "all" ]; then
            # Specific policy requested
            if [[ "$POLICY_FILE" == *.yml ]]; then
              POLICY_FILES="policies/periodic/$POLICY_FILE"
            else
              POLICY_FILES="policies/periodic/${POLICY_FILE}.yml"
            fi
            echo "üìÑ Running specific policy: $POLICY_FILE"
          else
            # Run all periodic policies
            POLICY_FILES=$(find policies/periodic -name "*.yml" -type f)
            echo "üìã Running all periodic policies"
          fi
          
          # Parse regions
          if [ "$REGIONS" == "all" ]; then
            REGION_LIST="us-east-1 us-west-2 eu-west-1 eu-central-1 ap-southeast-1"
            echo "üåç Running in all major regions"
          else
            REGION_LIST=$(echo "$REGIONS" | tr ',' ' ')
          fi
          
          # Build custodian command
          CUSTODIAN_CMD="custodian run"
          
          if [ "$DRY_RUN" == "true" ]; then
            CUSTODIAN_CMD="$CUSTODIAN_CMD --dryrun"
            echo "üîç DRY RUN MODE - No actions will be taken"
          fi
          
          # Track statistics
          TOTAL_POLICIES=0
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          TOTAL_RESOURCES=0
          
          # Run policies across regions
          for region in $REGION_LIST; do
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üåé Region: $region"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            
            for policy in $POLICY_FILES; do
              if [ -f "$policy" ]; then
                POLICY_NAME=$(basename "$policy" .yml)
                TOTAL_POLICIES=$((TOTAL_POLICIES + 1))
                
                echo ""
                echo "üìÑ Policy: $POLICY_NAME (Region: $region)"
                echo "   File: $policy"
                
                OUTPUT_DIR="output/periodic/${region}/${POLICY_NAME}"
                mkdir -p "$OUTPUT_DIR"
                
                # Run custodian
                if $CUSTODIAN_CMD \
                  -s "$OUTPUT_DIR" \
                  --region "$region" \
                  --output-dir "$OUTPUT_DIR" \
                  --cache-period 0 \
                  "$policy" 2>&1 | tee "$OUTPUT_DIR/execution.log"; then
                  
                  # Count resources found
                  if [ -f "$OUTPUT_DIR/resources.json" ]; then
                    RESOURCE_COUNT=$(jq '. | length' "$OUTPUT_DIR/resources.json" 2>/dev/null || echo "0")
                    TOTAL_RESOURCES=$((TOTAL_RESOURCES + RESOURCE_COUNT))
                    echo "   ‚úÖ Success: $RESOURCE_COUNT resources found"
                    SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                  else
                    echo "   ‚úÖ Success: 0 resources found"
                    SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                  fi
                else
                  echo "   ‚ùå Failed to execute $POLICY_NAME"
                  FAILED_COUNT=$((FAILED_COUNT + 1))
                fi
              fi
            done
          done
          
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìä Execution Summary"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "Total Policies Executed: $TOTAL_POLICIES"
          echo "Successful: $SUCCESS_COUNT"
          echo "Failed: $FAILED_COUNT"
          echo "Total Resources Found: $TOTAL_RESOURCES"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Export for summary step
          echo "TOTAL_POLICIES=$TOTAL_POLICIES" >> $GITHUB_ENV
          echo "SUCCESS_COUNT=$SUCCESS_COUNT" >> $GITHUB_ENV
          echo "FAILED_COUNT=$FAILED_COUNT" >> $GITHUB_ENV
          echo "TOTAL_RESOURCES=$TOTAL_RESOURCES" >> $GITHUB_ENV

      - name: Upload policy results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: periodic-policy-results-${{ steps.account.outputs.account_id }}
          path: c7n/output/periodic/
          retention-days: 30

      - name: Generate summary
        if: always()
        run: |
          echo "# üìä Cloud Custodian Periodic Policies Execution" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Account:** ${{ steps.account.outputs.account_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Regions:** ${{ github.event.inputs.regions || 'us-east-1' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Policy File:** ${{ github.event.inputs.policy_file || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Policies:** ${TOTAL_POLICIES:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- **‚úÖ Successful:** ${SUCCESS_COUNT:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- **‚ùå Failed:** ${FAILED_COUNT:-0}" >> $GITHUB_STEP_SUMMARY
          echo "- **üì¶ Total Resources Found:** ${TOTAL_RESOURCES:-0}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "c7n/output/periodic" ]; then
            echo "## Results by Region and Policy" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            for region_dir in c7n/output/periodic/*/; do
              if [ -d "$region_dir" ]; then
                REGION=$(basename "$region_dir")
                echo "### üåé Region: $REGION" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "| Policy | Resources Found | Status |" >> $GITHUB_STEP_SUMMARY
                echo "|--------|----------------|--------|" >> $GITHUB_STEP_SUMMARY
                
                for policy_output in "$region_dir"/*/resources.json; do
                  if [ -f "$policy_output" ]; then
                    POLICY_DIR=$(dirname "$policy_output")
                    POLICY_NAME=$(basename "$POLICY_DIR")
                    RESOURCE_COUNT=$(jq '. | length' "$policy_output" 2>/dev/null || echo "0")
                    
                    # Determine status icon
                    if [ -f "$(dirname "$policy_output")/execution.log" ]; then
                      if grep -q "ERROR" "$(dirname "$policy_output")/execution.log"; then
                        STATUS="‚ùå Error"
                      else
                        STATUS="‚úÖ Success"
                      fi
                    else
                      STATUS="‚ö†Ô∏è Unknown"
                    fi
                    
                    echo "| $POLICY_NAME | $RESOURCE_COUNT | $STATUS |" >> $GITHUB_STEP_SUMMARY
                  fi
                done
                echo "" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
            # Add quick links
            echo "## üìé Quick Links" >> $GITHUB_STEP_SUMMARY
            echo "- [Download Results Artifact](#)" >> $GITHUB_STEP_SUMMARY
            echo "- [View CloudWatch Logs](https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#logsV2:log-groups)" >> $GITHUB_STEP_SUMMARY
            echo "- [Security Hub Findings](https://console.aws.amazon.com/securityhub/home?region=us-east-1#/findings)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå No results generated" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Add available policy files
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìã Available Periodic Policies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cd c7n/policies/periodic
          echo "| Policy File | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|-------------|" >> $GITHUB_STEP_SUMMARY
          for policy in *.yml; do
            DESC=$(grep -m 1 "description:" "$policy" | sed 's/.*description: //' | tr -d '"' || echo "N/A")
            echo "| \`$policy\` | ${DESC:0:60}... |" >> $GITHUB_STEP_SUMMARY
          done
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ö†Ô∏è Periodic policy execution failed!"
          echo "Check the workflow logs for details."
          echo "Account: ${{ steps.account.outputs.account_id }}"
          echo "Failed policies: ${FAILED_COUNT:-unknown}"
          
          # You can add Slack/Teams/Email notification here
          # Example for Slack webhook:
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"‚ùå Cloud Custodian periodic policies failed for account ${{ steps.account.outputs.account_id }}"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}