policies:
  # ECR repository exposed to public
  - name: ecr-repository-public
    resource: aws.ecr
    description: Detect ECR repositories that are exposed to public
    
    filters:
      - type: cross-account
    
    actions:
      - type: notify
        template: default.html
        priority_header: "1"
        subject: "üö® CRITICAL: ECR Repository Exposed to Public - {{ region }}"
        violation_desc: |
          **ECR Repository Has Public or Cross-Account Access**
          
          **Repository Name:** {{ resource.repositoryName }}
          **Repository ARN:** {{ resource.repositoryArn }}
          **Repository URI:** {{ resource.repositoryUri }}
          
          **Risk:** Container images may be accessible to unauthorized accounts.
          
          **Remediation:**
          ```bash
          # Review repository policy
          aws ecr get-repository-policy --repository-name {{ resource.repositoryName }}
          
          # Remove public/cross-account access
          aws ecr delete-repository-policy --repository-name {{ resource.repositoryName }}
          
          # Set private policy (allow only current account)
          aws ecr set-repository-policy \
            --repository-name {{ resource.repositoryName }} \
            --policy-text '{
              "Version": "2012-10-17",
              "Statement": [{
                "Effect": "Allow",
                "Principal": {
                  "AWS": "arn:aws:iam::{{ account_id }}:root"
                },
                "Action": [
                  "ecr:GetDownloadUrlForLayer",
                  "ecr:BatchGetImage",
                  "ecr:BatchCheckLayerAvailability"
                ]
              }]
            }'
          ```
        to:
          - srinivasula.yallala@optum.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications

  # EKS control plane logging disabled
  - name: eks-control-plane-logging-disabled
    resource: aws.eks
    description: Detect EKS clusters with control plane logging disabled
    
    filters:
      - or:
        - type: value
          key: logging.clusterLogging[].enabled
          value: false
        - type: value
          key: logging.clusterLogging
          value: absent
        - type: value
          key: logging.clusterLogging
          value: empty
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "‚ö†Ô∏è EKS Control Plane Logging Disabled - {{ region }}"
        violation_desc: |
          **EKS Cluster Control Plane Logging Disabled**
          
          **Cluster Name:** {{ resource.name }}
          **Cluster ARN:** {{ resource.arn }}
          **Current Logging:** {{ resource.logging.clusterLogging }}
          
          **Risk:** Cannot audit API server, controller manager, or scheduler activity.
          
          **Remediation:**
          ```bash
          # Enable all control plane logging
          aws eks update-cluster-config \
            --name {{ resource.name }} \
            --logging '{
              "clusterLogging": [{
                "types": ["api", "audit", "authenticator", "controllerManager", "scheduler"],
                "enabled": true
              }]
            }'
          ```
        to:
          - srinivasula.yallala@optum.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications
