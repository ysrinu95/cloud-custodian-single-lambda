policies:
  # ALB with HTTP listener but no HTTPS listener - notify only
  - name: alb-missing-https-listener
    resource: aws.app-elb
    description: |
      Detect ALBs with HTTP listener but no HTTPS listener configured.
      Cannot auto-remediate because certificate is required for HTTPS.
    
    filters:
      - type: listener
        key: Protocol
        value: HTTP
      - not:
        - type: listener
          key: Protocol
          value: HTTPS
    
    actions:
      - type: notify
        template: default.html
        priority_header: "1"
        subject: "üî¥ ALB Missing HTTPS Listener - Manual Action Required - {{ region }}"
        violation_desc: |
          **Application Load Balancer Has HTTP But No HTTPS Listener**
          
          **Load Balancer:** {{ resource.LoadBalancerName }}
          **ARN:** {{ resource.LoadBalancerArn }}
          **DNS:** {{ resource.DNSName }}
          
          **Risk:** All traffic is unencrypted. HTTPS listener with certificate required.
          
          **Manual Remediation Required:**
          1. Request/import SSL certificate in ACM
          2. Create HTTPS listener:
          ```bash
          aws elbv2 create-listener \
            --load-balancer-arn {{ resource.LoadBalancerArn }} \
            --protocol HTTPS --port 443 \
            --certificates CertificateArn=arn:aws:acm:region:account:certificate/cert-id \
            --default-actions Type=forward,TargetGroupArn=<target-group-arn>
          ```
          3. Then modify HTTP listener to redirect to HTTPS
        to:
          - srinivasula.yallala@optum.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications
  
  # ALB listening on port 80 without redirect to HTTPS - notify only
  - name: alb-http-no-redirect-to-https
    resource: aws.app-elb
    description: |
      Detect ALBs listening on port 80 without redirect to HTTPS (443).
      Requires manual remediation to configure redirect action.
    
    filters:
      - type: listener
        key: Protocol
        value: HTTP
      - type: listener
        key: DefaultActions[0].Type
        value: redirect
        op: ne
      - or:
        - type: listener
          key: DefaultActions[0].RedirectConfig.Protocol
          value: HTTPS
          op: ne
        - type: listener
          key: DefaultActions[0].RedirectConfig
          value: absent
      # Only proceed if HTTPS listener exists (has certificate)
      - type: listener
        key: Protocol
        value: HTTPS
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "‚ö†Ô∏è ALB HTTP Listener Not Redirecting to HTTPS - {{ region }}"
        violation_desc: |
          **Application Load Balancer HTTP Listener Not Configured to Redirect to HTTPS**
          
          **Load Balancer:** {{ resource.LoadBalancerName }}
          **ARN:** {{ resource.LoadBalancerArn }}
          **DNS:** {{ resource.DNSName }}
          
          **Finding:** HTTP listener on port 80 is not redirecting to HTTPS. HTTPS listener exists.
          
          **Manual Remediation Required:**
          1. Get HTTP listener ARN:
          ```bash
          aws elbv2 describe-listeners --load-balancer-arn {{ resource.LoadBalancerArn }} \
            --query 'Listeners[?Protocol==`HTTP`].ListenerArn' --output text
          ```
          2. Configure redirect to HTTPS:
          ```bash
          aws elbv2 modify-listener \
            --listener-arn <http-listener-arn> \
            --default-actions Type=redirect,RedirectConfig='{Protocol=HTTPS,Port=443,StatusCode=HTTP_301}'
          ```
        to:
          - srinivasula.yallala@optum.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications

  # ALB not using latest predefined security policy - realtime/periodic
  - name: alb-outdated-ssl-policy
    resource: aws.app-elb
    description: Detect ALBs not using the latest predefined security policy (ELBSecurityPolicy-TLS13-1-2-2021-06)
    
    filters:
      - type: listener
        key: Protocol
        value: HTTPS
      - type: listener
        key: SslPolicy
        value: ELBSecurityPolicy-TLS13-1-2-2021-06
        op: ne
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "‚ö†Ô∏è ALB Using Outdated SSL Policy - {{ region }}"
        violation_desc: |
          **Application Load Balancer Using Outdated SSL/TLS Policy**
          
          **Load Balancer:** {{ resource.LoadBalancerName }}
          **Current SSL Policy:** {% set https_listeners = resource['c7n:MatchedListeners'] | selectattr('Protocol', 'equalto', 'HTTPS') | list %}{% if https_listeners %}{{ https_listeners[0].SslPolicy }}{% endif %}
          **Recommended:** ELBSecurityPolicy-TLS13-1-2-2021-06
          
          **Remediation:**
          {% set https_listeners = resource['c7n:MatchedListeners'] | selectattr('Protocol', 'equalto', 'HTTPS') | list %}{% for listener in https_listeners %}```bash
          aws elbv2 modify-listener \
            --listener-arn {{ listener.ListenerArn }} \
            --ssl-policy ELBSecurityPolicy-TLS13-1-2-2021-06
          ```
          {% endfor %}
        to:
          - srinivasula.yallala@optum.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications

  # ALBv2/NLBv2 access logging not to central bucket - cloudtrail/periodic
  - name: elbv2-logging-not-central-bucket
    resource: aws.app-elb
    description: Detect Application/Network Load Balancers with access logging disabled or not configured to central logging bucket
    
    # Note: Event-driven execution triggered by ModifyLoadBalancerAttributes only
    # - ModifyLoadBalancerAttributes: Template extracts bucket from event.detail.responseElements
    #   and validates compliance (‚úÖ lp-cl* prefix or ‚ö†Ô∏è violation)
    # - Periodic execution: Validates actual Attributes to catch ALBs without logging
    # Filters match when Attributes absent (events) or present with violations (periodic)
    filters:
      - or:
        # When Attributes field doesn't exist (CloudTrail events)
        - type: value
          key: Attributes
          value: absent
        # When Attributes exist (periodic mode), check if logging is disabled
        - type: value
          key: Attributes.access_logs.s3.enabled
          value: false
        # When logging is enabled, check if it's to the wrong bucket
        - and:
          - type: value
            key: Attributes.access_logs.s3.enabled
            value: true
          - not:
            - type: value
              key: Attributes.access_logs.s3.bucket
              op: regex
              value: "^lp-cl.*"
    
    actions:
      - type: notify
        template: default.html
        priority_header: "3"
        subject: "ELBv2 Logging Configuration - {{ region }}"
        violation_desc: |
          {% set bucket = event.detail.responseElements.attributes | selectattr('key', 'equalto', 'access_logs.s3.bucket') | map(attribute='value') | first if event and event.detail and event.detail.responseElements else '' %}
          {% set enabled = event.detail.responseElements.attributes | selectattr('key', 'equalto', 'access_logs.s3.enabled') | map(attribute='value') | first if event and event.detail and event.detail.responseElements else '' %}
          {% if bucket and bucket.startswith('lp-cl') %}
          **‚úÖ COMPLIANT: Application/Network Load Balancer Logging Configured to Central Bucket**
          
          **Load Balancer:** {{ resource.LoadBalancerName }}
          **Type:** {{ resource.Type }}
          **ARN:** {{ resource.LoadBalancerArn }}
          **Logging Status:** Enabled to bucket: **{{ bucket }}** ‚úÖ
          **Status:** This configuration is COMPLIANT with security policy (lp-cl* prefix)
          
          No action required.
          {% else %}
          **‚ö†Ô∏è VIOLATION: Application/Network Load Balancer Access Logging Not to Central Bucket**
          
          **Load Balancer:** {{ resource.LoadBalancerName }}
          **Type:** {{ resource.Type }}
          **ARN:** {{ resource.LoadBalancerArn }}
          **Current Logging Status:** {% if bucket %}Enabled to bucket: {{ bucket }}{% elif enabled == 'false' %}Disabled{% else %}{% if resource.Attributes and resource.Attributes.access_logs.s3.enabled %}Enabled to bucket: {{ resource.Attributes.access_logs.s3.bucket }}{% else %}Not configured{% endif %}{% endif %}
          **Required:** Logging to bucket with prefix lp-cl*
          
          **Remediation:**
          ```bash
          aws elbv2 modify-load-balancer-attributes \
            --load-balancer-arn {{ resource.LoadBalancerArn }} \
            --attributes \
              Key=access_logs.s3.enabled,Value=true \
              Key=access_logs.s3.bucket,Value=lp-cl-logging-bucket \
              Key=access_logs.s3.prefix,Value=service=elbv2
          ```
          {% endif %}
        to:
          - compliance-team@company.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications

  # ELBv2 with listener TLS not configured - cloudtrail/periodic
  - name: elbv2-no-tls-listener
    resource: aws.app-elb
    description: Detect Application/Network Load Balancers without TLS listener configured
    
    filters:
      - not:
        - type: listener
          key: Protocol
          value: HTTPS
      - not:
        - type: listener
          key: Protocol
          value: TLS
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "‚ö†Ô∏è ELBv2 Missing TLS Listener - {{ region }}"
        violation_desc: |
          **Load Balancer Without TLS/HTTPS Listener**
          
          **Load Balancer:** {{ resource.LoadBalancerName }}
          **Type:** {{ resource.Type }}
          **Available Listeners:** {{ resource.Listeners[*].Protocol }}
          
          **Risk:** All traffic is unencrypted, vulnerable to interception.
          
          **Remediation:**
          ```bash
          aws elbv2 create-listener \
            --load-balancer-arn {{ resource.LoadBalancerArn }} \
            --protocol HTTPS \
            --port 443 \
            --certificates CertificateArn=<cert-arn> \
            --ssl-policy ELBSecurityPolicy-TLS13-1-2-2021-06 \
            --default-actions Type=forward,TargetGroupArn=<target-group-arn>
          ```
        to:
          - srinivasula.yallala@optum.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications

  # NLB not using latest predefined security policy - periodic
  - name: nlb-outdated-ssl-policy
    resource: aws.app-elb
    description: Detect Network Load Balancers not using the latest predefined security policy
    
    filters:
      - type: value
        key: Type
        value: network
      - type: listener
        key: Protocol
        value: TLS
      - type: listener
        key: SslPolicy
        value: ELBSecurityPolicy-TLS13-1-2-2021-06
        op: ne
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "‚ö†Ô∏è NLB Using Outdated SSL Policy - {{ region }}"
        violation_desc: |
          **Network Load Balancer Using Outdated SSL/TLS Policy**
          
          **Load Balancer:** {{ resource.LoadBalancerName }}
          **Current SSL Policy:** {{ resource.Listeners[?Protocol=='TLS'].SslPolicy | [0] }}
          **Recommended:** ELBSecurityPolicy-TLS13-1-2-2021-06
          
          **Remediation:**
          ```bash
          aws elbv2 modify-listener \
            --listener-arn <listener-arn> \
            --ssl-policy ELBSecurityPolicy-TLS13-1-2-2021-06
          ```
        to:
          - srinivasula.yallala@optum.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications
