policies:
  # S3 bucket with global PUT permissions via bucket policy
  - name: s3-global-put-permissions
    resource: aws.s3
    description: Detect S3 buckets with global PUT permissions enabled via bucket policy
    
    filters:
      - type: has-statement
        statements:
          - Effect: Allow
            Principal: "*"
            Action:
              - "s3:PutObject*"
              - "s3:Put*"
    
    actions:
      - type: notify
        template: default.html
        priority_header: "1"
        subject: "üö® CRITICAL: S3 Bucket Has Global PUT Permissions - {{ account }} - {{ region }}"
        violation_desc: |
          **S3 Bucket Allows Global PUT Permissions**
          
          **Bucket Name:** {{ resource.Name }}
          **Region:** {{ region }}
          **Account:** {{ account }}
          **Created By:** {{ resource["c7n:CreatorName"] or "Unknown" }}
          
          **Risk:** Anyone on internet can upload objects to this bucket (potential cost/legal issues).
          
          **Remediation:**
          ```bash
          # Review bucket policy
          aws s3api get-bucket-policy --bucket {{ resource.Name }}
          
          # Remove or restrict the policy
          aws s3api delete-bucket-policy --bucket {{ resource.Name }}
          ```
        to:
          - srinivasula.yallala@optum.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications

  # S3 bucket with global permissions (GET/LIST)
  - name: s3-global-permissions
    resource: aws.s3
    description: Detect S3 buckets with global GET/LIST permissions via bucket policy
    
    filters:
      - type: has-statement
        statements:
          - Effect: Allow
            Principal: "*"
            Action:
              - "s3:GetObject*"
              - "s3:Get*"
              - "s3:List*"
    
    actions:
      - type: notify
        template: default.html
        priority_header: "1"
        subject: "üö® CRITICAL: S3 Bucket Has Global Permissions - {{ account }} - {{ region }}"
        violation_desc: |
          **S3 Bucket Allows Global Read Permissions**
          
          **Bucket Name:** {{ resource.Name }}
          **Account:** {{ account }}
          **Region:** {{ region }}
          **Created By:** {{ resource["c7n:CreatorName"] or "Unknown" }}
          **Risk:** Sensitive data may be exposed to public.
          
          **Remediation:**
          ```bash
          aws s3api delete-bucket-policy --bucket {{ resource.Name }}
          ```
        to:
          - srinivasula.yallala@optum.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications

  # S3 bucket public access block disabled
  - name: s3-public-access-block-disabled
    resource: aws.s3
    description: Detect S3 buckets with public access block settings disabled
    
    filters:
      - or:
        - type: value
          key: PublicAccessBlockConfiguration.BlockPublicAcls
          value: false
        - type: value
          key: PublicAccessBlockConfiguration.IgnorePublicAcls
          value: false
        - type: value
          key: PublicAccessBlockConfiguration.BlockPublicPolicy
          value: false
        - type: value
          key: PublicAccessBlockConfiguration.RestrictPublicBuckets
          value: false
        - type: value
          key: PublicAccessBlockConfiguration
          value: absent
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "‚ö†Ô∏è S3 Bucket Public Access Block Disabled - {{ account }} - {{ region }}"
        violation_desc: |
          **S3 Bucket Public Access Block Settings Disabled**
          
          **Bucket Name:** {{ resource.Name }}
          **Account:** {{ account }}
          **Region:** {{ region }}
          **Created By:** {{ resource["c7n:CreatorName"] or "Unknown" }}
          **Current Config:** {{ resource.PublicAccessBlockConfiguration }}
          
          **Risk:** Bucket may inadvertently become public.
          
          **Remediation:**
          ```bash
          aws s3api put-public-access-block \
            --bucket {{ resource.Name }} \
            --public-access-block-configuration \
            "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
          ```
        to:
          - srinivasula.yallala@optum.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications
      
      - type: set-public-block
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        RestrictPublicBuckets: true

  # S3 bucket with global view ACL permissions
  - name: s3-global-view-acl
    resource: aws.s3
    description: Detect S3 buckets with global view ACL permissions enabled
    
    filters:
      - type: global-grants
        allow_website: false
        operator: or
        permissions:
          - READ
          - READ_ACP
    
    actions:
      - type: notify
        template: default.html
        priority_header: "1"
        subject: "üö® CRITICAL: S3 Bucket Has Global View ACL - {{ account }} - {{ region }}"
        violation_desc: |
          **S3 Bucket Has Global ACL Permissions**
          
          **Bucket Name:** {{ resource.Name }}
          **Account:** {{ account }}
          **Region:** {{ region }}
          **Created By:** {{ resource["c7n:CreatorName"] or "Unknown" }}
          **ACL Grants:** {{ resource.Acl.Grants[?Grantee.Type=='Group'] }}
          
          **Risk:** Bucket contents are publicly readable.
          
          **Remediation:**
          ```bash
          # Set private ACL
          aws s3api put-bucket-acl --bucket {{ resource.Name }} --acl private
          ```
        to:
          - srinivasula.yallala@optum.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications
      
      - type: delete-global-grants
        grantees:
          - "http://acs.amazonaws.com/groups/global/AllUsers"
          - "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"

  # S3 bucket accessible to public via ACL
  - name: s3-public-via-acl
    resource: aws.s3
    description: Detect S3 buckets accessible to public via ACL
    
    filters:
      - type: global-grants
        allow_website: false
        operator: or
        permissions:
          - READ
          - WRITE
          - READ_ACP
          - WRITE_ACP
          - FULL_CONTROL
    
    actions:
      - type: notify
        template: default.html
        priority_header: "1"
        subject: "üö® CRITICAL: S3 Bucket Publicly Accessible via ACL - {{ account }} - {{ region }}"
        violation_desc: |
          **S3 Bucket Publicly Accessible via ACL**
          
          **Bucket Name:** {{ resource.Name }}
          **Account:** {{ account }}
          **Region:** {{ region }}
          **Created By:** {{ resource["c7n:CreatorName"] or "Unknown" }}
          **Public Permissions:** {% for grant in resource.Acl.Grants %}{% if grant.Grantee.Type == 'Group' %}{{ grant.Permission }}{% if not loop.last %}, {% endif %}{% endif %}{% endfor %}
          
          **Risk:** Data exposure or unauthorized modifications.
          
          **Remediation:**
          ```bash
          aws s3api put-bucket-acl --bucket {{ resource.Name }} --acl private
          ```
        to:
          - srinivasula.yallala@optum.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications
      
      - type: delete-global-grants
        grantees:
          - "http://acs.amazonaws.com/groups/global/AllUsers"
          - "http://acs.amazonaws.com/groups/global/AuthenticatedUsers"

  # S3 bucket without server-side encryption
  - name: s3-no-server-side-encryption
    resource: aws.s3
    description: Detect S3 buckets without server-side encryption enabled
    
    filters:
      - type: bucket-encryption
        state: false
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "‚ö†Ô∏è S3 Bucket Without Server-Side Encryption - {{ account }} - {{ region }}"
        violation_desc: |
          **S3 Bucket Does Not Have Server-Side Encryption**
          
          **Bucket Name:** {{ resource.Name }}
          **Account:** {{ account }}
          **Region:** {{ region }}
          **Created By:** {{ resource["c7n:CreatorName"] or "Unknown" }}
          
          **Risk:** Data at rest is not encrypted.
          
          **Remediation:**
          ```bash
          # Enable AES256 encryption
          aws s3api put-bucket-encryption \
            --bucket {{ resource.Name }} \
            --server-side-encryption-configuration '{
              "Rules": [{
                "ApplyServerSideEncryptionByDefault": {
                  "SSEAlgorithm": "AES256"
                }
              }]
            }'
          
          # Or use KMS encryption
          aws s3api put-bucket-encryption \
            --bucket {{ resource.Name }} \
            --server-side-encryption-configuration '{
              "Rules": [{
                "ApplyServerSideEncryptionByDefault": {
                  "SSEAlgorithm": "aws:kms",
                  "KMSMasterKeyID": "<kms-key-id>"
                }
              }]
            }'
          ```
        to:
          - srinivasula.yallala@optum.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications
      
      # Auto-remediation disabled for dev/test - enable in production accounts only
      # Requires s3:PutEncryptionConfiguration permission
      # - type: set-bucket-encryption
      #   enabled: true
      #   crypto: AES256

  # S3 bucket not configured with secure data transport policy
  - name: s3-no-secure-transport-policy
    resource: aws.s3
    description: Detect S3 buckets without secure transport (HTTPS) enforcement
    
    filters:
      - not:
        - type: has-statement
          statement_ids:
            - RequireSecureTransport
    
    actions:
      - type: notify
        template: default.html
        priority_header: "2"
        subject: "‚ö†Ô∏è S3 Bucket Without Secure Transport Policy - {{ account }} - {{ region }}"
        violation_desc: |
          **S3 Bucket Does Not Enforce HTTPS**
          
          **Bucket Name:** {{ resource.Name }}
          **Account:** {{ account }}
          **Region:** {{ region }}
          **Created By:** {{ resource["c7n:CreatorName"] or "Unknown" }}
          
          **Risk:** Data in transit may be transmitted over HTTP.
          
          **Remediation:**
          ```bash
          # Add policy to enforce HTTPS
          aws s3api put-bucket-policy --bucket {{ resource.Name }} --policy '{
            "Version": "2012-10-17",
            "Statement": [{
              "Sid": "RequireSecureTransport",
              "Effect": "Deny",
              "Principal": "*",
              "Action": "s3:*",
              "Resource": [
                "arn:aws:s3:::{{ resource.Name }}",
                "arn:aws:s3:::{{ resource.Name }}/*"
              ],
              "Condition": {
                "Bool": {"aws:SecureTransport": "false"}
              }
            }]
          }'
          ```
        to:
          - srinivasula.yallala@optum.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/aikyam-cloud-custodian-realtime-notifications
