policies:
- name: ec2-security-group-ssh-remediation-event
  resource: aws.security-group
  description: 'Removes unrestricted SSH access (0.0.0.0/0). Triggered by Lambda on CloudTrail events: CreateSecurityGroup, AuthorizeSecurityGroupIngress. Lambda passes the security group ID from event data.'
  filters:
  - type: ingress
    Ports:
    - 22
    Cidr:
      value: 0.0.0.0/0
  actions:
  - type: remove-permissions
    ingress: matched
  - type: tag
    tags:
      c7n-violation: unrestricted-ssh
      c7n-remediation-date: '{now:%Y-%m-%d}'
      c7n-remediation-action: rule-removed
  - type: post-finding
    severity_label: HIGH
    compliance_status: FAILED
    title: Security Group with Unrestricted SSH Access - Remediated
    description: 'A security group was configured with SSH (port 22) open to 0.0.0.0/0.

      The unrestricted rule has been automatically removed.

      '
    recommendation: 'Use AWS Systems Manager Session Manager for instance access instead
      of SSH.

      If SSH is required, restrict access to specific IP ranges or use a bastion host.

      '
    types:
    - Software and Configuration Checks/AWS Security Best Practices
  - template: aws-basic_email.html
    to:
    - ysrinu95@gmail.com
    - event-owner
    - resource-owner
    transport:
      type: sqs
      queue: https://sqs.us-west-2.amazonaws.com/172327596604/custodian-mailer-queue
    type: notify
    priority_header: 1
    subject: '[c7n] [{{ account }}] Security Group with Unrestricted SSH Access -
      Remediated ({{ region }})'
    violation_desc: Security group configured with SSH open to 0.0.0.0/0
    action_desc: 'Actions taken: The unrestricted SSH rule has been removed.'
