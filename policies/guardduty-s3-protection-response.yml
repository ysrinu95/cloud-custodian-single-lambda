policies:
  # ============================================================================
  # GUARDDUTY S3 PROTECTION - CLOUD CUSTODIAN RESPONSE POLICIES
  # Automated remediation for GuardDuty S3 threat findings
  # ============================================================================
  
  # Based on: https://docs.aws.amazon.com/guardduty/latest/ug/s3-protection.html
  # GuardDuty S3 Protection Finding Types:
  # - Discovery:S3/* - Anomalous S3 API activity
  # - Exfiltration:S3/* - Data exfiltration attempts
  # - Impact:S3/* - S3 resource compromise
  # - PenTest:S3/* - Penetration testing activity
  # - Policy:S3/* - Policy/permission changes
  # - Stealth:S3/* - Stealthy API calls
  # - UnauthorizedAccess:S3/* - Credential compromise
  
  # -------------------------------------------------------------------------
  # EXFILTRATION FINDINGS
  # -------------------------------------------------------------------------
  
  # Policy 1: Respond to Anomalous Object Download (Data Exfiltration)
  - name: guardduty-s3-exfiltration-anomalous-download
    resource: aws.s3
    description: |
      Responds to GuardDuty finding: Exfiltration:S3/AnomalousObjectDownload
      Unusual number of GetObject API calls from a suspicious IP address
    filters:
      - type: event
        key: "detail.type"
        value: "Exfiltration:S3/AnomalousObjectDownload"
      - type: event
        key: "detail.severity"
        op: gte
        value: 7.0
    actions:
      - type: set-public-block
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      - type: tag
        key: GuardDutyFinding
        value: "Exfiltration-AnomalousDownload"
      - type: tag
        key: SecurityIncident
        value: "Active"
      - type: notify
        template: default
        priority_header: "1"
        subject: "CRITICAL: GuardDuty Detected S3 Data Exfiltration Attempt"
        violation_desc: "Anomalous GetObject API calls detected - possible data theft"
        action_desc: "Public access blocked on bucket"
        to:
          - security@example.com
          - ysrinu95@gmail.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/cloud-custodian-mailer-queue-prod

  # Policy 2: Respond to Anomalous Object Replication
  - name: guardduty-s3-exfiltration-object-replication
    resource: aws.s3
    description: |
      Responds to GuardDuty finding: Exfiltration:S3/ObjectRead.Unusual
      Suspicious S3 replication or cross-region copy detected
    filters:
      - type: event
        key: "detail.type"
        op: regex
        value: "Exfiltration:S3/(ObjectRead.Unusual|MaliciousIPCaller)"
    actions:
      - type: delete-bucket-replication
      - type: set-public-block
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      - type: tag
        key: GuardDutyFinding
        value: "Exfiltration-ObjectRead"
      - type: notify
        template: default
        priority_header: "1"
        subject: "CRITICAL: GuardDuty Detected Unusual S3 Object Access"
        violation_desc: "Unusual S3 object reads from suspicious source"
        action_desc: "Replication deleted, public access blocked"
        to:
          - security@example.com
          - ysrinu95@gmail.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/cloud-custodian-mailer-queue-prod

  # -------------------------------------------------------------------------
  # IMPACT FINDINGS (Bucket Compromise)
  # -------------------------------------------------------------------------
  
  # Policy 3: Respond to Permissions Modification
  - name: guardduty-s3-impact-permissions-modification
    resource: aws.s3
    description: |
      Responds to GuardDuty finding: Impact:S3/PermissionsModification.Unusual
      S3 bucket permissions modified in an unusual way
    filters:
      - type: event
        key: "detail.type"
        op: regex
        value: "Impact:S3/(PermissionsModification.Unusual|BucketPolicyModification.Unusual)"
    actions:
      - type: set-public-block
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      - type: remove-statements
        statement_ids: matched
      - type: tag
        key: GuardDutyFinding
        value: "Impact-PermissionsModified"
      - type: tag
        key: RequiresReview
        value: "Immediate"
      - type: notify
        template: default
        priority_header: "1"
        subject: "CRITICAL: GuardDuty Detected S3 Permissions Tampering"
        violation_desc: "S3 bucket permissions or policy modified suspiciously"
        action_desc: "Public access blocked, suspicious policy statements removed"
        to:
          - security@example.com
          - ysrinu95@gmail.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/cloud-custodian-mailer-queue-prod

  # Policy 4: Respond to Malicious Activity
  - name: guardduty-s3-impact-malicious-activity
    resource: aws.s3
    description: |
      Responds to GuardDuty finding: Impact:S3/MaliciousIPCaller*
      S3 API called from a known malicious IP address
    filters:
      - type: event
        key: "detail.type"
        op: regex
        value: "Impact:S3/MaliciousIPCaller"
      - type: event
        key: "detail.severity"
        op: gte
        value: 7.0
    actions:
      - type: set-public-block
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      - type: delete-bucket-policy
      - type: tag
        key: GuardDutyFinding
        value: "Impact-MaliciousIP"
      - type: tag
        key: ThreatLevel
        value: "Critical"
      - type: notify
        template: default
        priority_header: "1"
        subject: "CRITICAL: GuardDuty Detected S3 Access from Malicious IP"
        violation_desc: "S3 bucket accessed from known malicious IP address"
        action_desc: "Public access blocked, bucket policy removed"
        to:
          - security@example.com
          - ysrinu95@gmail.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/cloud-custodian-mailer-queue-prod

  # -------------------------------------------------------------------------
  # UNAUTHORIZED ACCESS FINDINGS
  # -------------------------------------------------------------------------
  
  # Policy 5: Respond to Compromised Credentials
  - name: guardduty-s3-unauthorized-access-credentials
    resource: aws.s3
    description: |
      Responds to GuardDuty finding: UnauthorizedAccess:S3/MaliciousIPCaller.Custom
      S3 accessed using potentially compromised AWS credentials
    filters:
      - type: event
        key: "detail.type"
        op: regex
        value: "UnauthorizedAccess:S3/(MaliciousIPCaller|TorIPCaller)"
    actions:
      - type: set-public-block
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      - type: tag
        key: GuardDutyFinding
        value: "UnauthorizedAccess-Credentials"
      - type: tag
        key: CredentialCompromise
        value: "Suspected"
      - type: notify
        template: default
        priority_header: "1"
        subject: "CRITICAL: GuardDuty Detected S3 Access with Compromised Credentials"
        violation_desc: "S3 accessed from Tor network or malicious IP - credential compromise suspected"
        action_desc: "Bucket access restricted, IAM credential review required"
        to:
          - security@example.com
          - ysrinu95@gmail.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/cloud-custodian-mailer-queue-prod

  # -------------------------------------------------------------------------
  # DISCOVERY FINDINGS (Reconnaissance)
  # -------------------------------------------------------------------------
  
  # Policy 6: Respond to Anomalous S3 Discovery
  - name: guardduty-s3-discovery-anomalous-activity
    resource: aws.s3
    description: |
      Responds to GuardDuty finding: Discovery:S3/AnomalousBehavior
      Unusual S3 API calls that may indicate reconnaissance
    filters:
      - type: event
        key: "detail.type"
        op: regex
        value: "Discovery:S3/(AnomalousBehavior|TorIPCaller|MaliciousIPCaller)"
    actions:
      - type: set-public-block
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      - type: tag
        key: GuardDutyFinding
        value: "Discovery-Reconnaissance"
      - type: tag
        key: MonitoringRequired
        value: "Enhanced"
      - type: notify
        template: default
        priority_header: "2"
        subject: "WARNING: GuardDuty Detected S3 Reconnaissance Activity"
        violation_desc: "Unusual S3 discovery activity - possible attack preparation"
        action_desc: "Public access blocked, monitoring enhanced"
        to:
          - security@example.com
          - ysrinu95@gmail.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/cloud-custodian-mailer-queue-prod

  # -------------------------------------------------------------------------
  # POLICY FINDINGS (Configuration Changes)
  # -------------------------------------------------------------------------
  
  # Policy 7: Respond to Bucket Encryption Disabled
  - name: guardduty-s3-policy-encryption-disabled
    resource: aws.s3
    description: |
      Responds to GuardDuty finding: Policy:S3/BucketEncryptionDisabled
      S3 bucket encryption was disabled
    filters:
      - type: event
        key: "detail.type"
        value: "Policy:S3/BucketEncryptionDisabled"
    actions:
      - type: set-bucket-encryption
        enabled: true
        crypto: AES256
      - type: tag
        key: GuardDutyFinding
        value: "Policy-EncryptionDisabled"
      - type: tag
        key: AutoRemediated
        value: "EncryptionEnabled"
      - type: notify
        template: default
        priority_header: "1"
        subject: "CRITICAL: GuardDuty Detected S3 Encryption Disabled"
        violation_desc: "S3 bucket encryption was disabled"
        action_desc: "Encryption re-enabled with AES256"
        to:
          - security@example.com
          - ysrinu95@gmail.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/cloud-custodian-mailer-queue-prod

  # Policy 8: Respond to Bucket Versioning Disabled
  - name: guardduty-s3-policy-versioning-disabled
    resource: aws.s3
    description: |
      Responds to GuardDuty finding: Policy:S3/BucketVersioningDisabled
      S3 bucket versioning was disabled (ransomware preparation)
    filters:
      - type: event
        key: "detail.type"
        value: "Policy:S3/BucketVersioningDisabled"
    actions:
      - type: toggle-versioning
        enabled: true
      - type: tag
        key: GuardDutyFinding
        value: "Policy-VersioningDisabled"
      - type: tag
        key: RansomwareIndicator
        value: "VersioningDisabled"
      - type: notify
        template: default
        priority_header: "1"
        subject: "CRITICAL: GuardDuty Detected S3 Versioning Disabled - Ransomware Indicator"
        violation_desc: "S3 bucket versioning disabled - possible ransomware attack preparation"
        action_desc: "Versioning re-enabled automatically"
        to:
          - security@example.com
          - ysrinu95@gmail.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/cloud-custodian-mailer-queue-prod

  # Policy 9: Respond to Public Access Granted
  - name: guardduty-s3-policy-public-access-granted
    resource: aws.s3
    description: |
      Responds to GuardDuty finding: Policy:S3/BucketPublicAccessGranted
      S3 bucket made publicly accessible
    filters:
      - type: event
        key: "detail.type"
        op: regex
        value: "Policy:S3/(BucketPublicAccessGranted|BucketAnonymousAccessGranted)"
    actions:
      - type: set-public-block
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      - type: delete-bucket-policy
      - type: tag
        key: GuardDutyFinding
        value: "Policy-PublicAccess"
      - type: tag
        key: ExfiltrationRisk
        value: "High"
      - type: notify
        template: default
        priority_header: "1"
        subject: "CRITICAL: GuardDuty Detected S3 Bucket Made Public"
        violation_desc: "S3 bucket made publicly accessible"
        action_desc: "Public access blocked, policy removed"
        to:
          - security@example.com
          - ysrinu95@gmail.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/cloud-custodian-mailer-queue-prod

  # -------------------------------------------------------------------------
  # STEALTH FINDINGS (Evasion Techniques)
  # -------------------------------------------------------------------------
  
  # Policy 10: Respond to S3 Logging Disabled
  - name: guardduty-s3-stealth-logging-disabled
    resource: aws.s3
    description: |
      Responds to GuardDuty finding: Stealth:S3/ServerAccessLoggingDisabled
      S3 server access logging was disabled (covering tracks)
    filters:
      - type: event
        key: "detail.type"
        value: "Stealth:S3/ServerAccessLoggingDisabled"
    actions:
      - type: toggle-logging
        target_bucket: "{account_id}-s3-access-logs"
        target_prefix: "{source_bucket_name}/"
      - type: tag
        key: GuardDutyFinding
        value: "Stealth-LoggingDisabled"
      - type: tag
        key: ForensicsRequired
        value: "LogsDisabled"
      - type: notify
        template: default
        priority_header: "1"
        subject: "CRITICAL: GuardDuty Detected S3 Logging Disabled - Evasion Attempt"
        violation_desc: "S3 access logging disabled - attacker covering tracks"
        action_desc: "Access logging re-enabled"
        to:
          - security@example.com
          - ysrinu95@gmail.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/cloud-custodian-mailer-queue-prod

  # -------------------------------------------------------------------------
  # PENTEST FINDINGS (Testing Activity)
  # -------------------------------------------------------------------------
  
  # Policy 11: Respond to Penetration Testing Tools
  - name: guardduty-s3-pentest-tools-detected
    resource: aws.s3
    description: |
      Responds to GuardDuty finding: PenTest:S3/KaliLinux or PenTest:S3/ParrotLinux
      S3 accessed from known penetration testing tools
    filters:
      - type: event
        key: "detail.type"
        op: regex
        value: "PenTest:S3/(KaliLinux|ParrotLinux|PentooLinux)"
    actions:
      - type: tag
        key: GuardDutyFinding
        value: "PenTest-ToolsDetected"
      - type: tag
        key: AuthorizedPenTest
        value: "RequiresValidation"
      - type: notify
        template: default
        priority_header: "2"
        subject: "WARNING: GuardDuty Detected S3 Access from PenTest Tools"
        violation_desc: "S3 accessed from penetration testing tools (Kali/Parrot Linux)"
        action_desc: "Validate if this is authorized security testing"
        to:
          - security@example.com
          - ysrinu95@gmail.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/cloud-custodian-mailer-queue-prod

  # -------------------------------------------------------------------------
  # COMPREHENSIVE MONITORING
  # -------------------------------------------------------------------------
  
  # Policy 12: Monitor All GuardDuty S3 Findings (Catch-All)
  - name: guardduty-s3-all-findings-monitor
    resource: aws.s3
    description: |
      Monitors all GuardDuty S3 Protection findings for tracking and alerting
      Captures any new finding types not covered by specific policies
    filters:
      - type: event
        key: "source"
        value: "aws.guardduty"
      - type: event
        key: "detail.type"
        op: regex
        value: "^(Discovery|Exfiltration|Impact|PenTest|Policy|Stealth|UnauthorizedAccess):S3/"
    actions:
      - type: tag
        key: GuardDutyMonitored
        value: "True"
      - type: tag
        key: LastGuardDutyFinding
        value: "{now:%Y-%m-%d}"
      - type: notify
        template: default
        priority_header: "3"
        subject: "INFO: GuardDuty S3 Finding - {detail.type}"
        violation_desc: "GuardDuty S3 Protection finding: {detail.type}"
        action_desc: "Monitoring and tracking - review finding details"
        to:
          - ysrinu95@gmail.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/cloud-custodian-mailer-queue-prod
