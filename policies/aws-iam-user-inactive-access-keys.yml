policies:
- name: aws-iam-user-inactive-access-keys
  resource: aws.iam-user
  description: 'Notifies of and disables IAM access keys found to be unused'
  filters:
  - type: credential
    key: access_keys.active
    value: true
    op: eq
  - type: credential
    key: access_keys.last_used_date
    value_type: age
    value: 90
    op: gt
  - type: value
    key: length("c7n:matched-keys")
    value: 1
    op: gte
  - type: value
    key: tag:squad
    value: data
    op: ne
  actions:
  - type: remove-keys
    matched: true
    disable: true
  - template: aws-basic_email.html
    to: &id001
    - ysrinu95@gmail.com
    - event-owner
    - resource-owner
    transport: &id002
      type: sqs
      queue: https://sqs.us-west-2.amazonaws.com/172327596604/custodian-mailer-queue
    type: notify
    subject: '[c7n] [{{ account }}] IAM Users With Access Keys Not Recently Used'
    violation_desc: IAM user access keys not used in the last 90 days
    action_desc: 'Unused IAM access keys have been disabled.<br>

      If the user is still needed, consider switching it to an IAM role instead.

      '
  - template: aws-basic_email.html
    to: *id001
    transport: *id002
    type: notify
    violation_desc: 'IAM user access keys not used in the last 90 days

      '
    action_desc: 'Unused IAM access keys have been disabled.

      '
vars:
  tags:
    contact: ysrinu95@gmail.com
    environment: production
    repo: ysrinu95/cloud-custodian
  email-notify:
    template: aws-basic_email.html
    to:
    - ysrinu95@gmail.com
    - event-owner
    - resource-owner
    transport:
      type: sqs
      queue: https://sqs.us-west-2.amazonaws.com/172327596604/custodian-mailer-queue
