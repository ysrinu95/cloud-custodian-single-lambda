policies:
  # Policy 1: Check for public S3 bucket access on bucket creation
  - name: s3-bucket-public-access-check
    resource: s3
    description: Check and remediate S3 buckets with public access on creation
    filters:
      - or:
          - type: value
            key: Acl
            value: "public-read"
          - type: value
            key: Acl
            value: "public-read-write"
          - type: check-public-block
            BlockPublicAcls: false
    actions:
      - type: set-public-block
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      - type: notify
        template: aws-basic_email.html
        subject: "Cloud Custodian: Public S3 Bucket Detected and Remediated"
        to:
          - security@example.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # Policy 2: Check S3 bucket ACL modifications
  - name: s3-bucket-acl-check
    resource: s3
    description: Monitor and remediate S3 bucket ACL changes that expose data publicly
    filters:
      - or:
          - type: value
            key: Acl
            value: "public-read"
          - type: value
            key: Acl
            value: "public-read-write"
    actions:
      - type: set-public-block
        BlockPublicAcls: true
        IgnorePublicAcls: true
      - type: notify
        template: aws-basic_email.html
        subject: "Cloud Custodian: S3 Bucket ACL Made Public - Remediated"
        to:
          - security@example.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # Policy 3: Check S3 bucket policy modifications
  - name: s3-bucket-policy-check
    resource: s3
    description: Monitor S3 bucket policy changes for public access
    filters:
      - type: has-statement
        statement_ids:
          - "*"
        statements:
          - Effect: Allow
            Principal: "*"
    actions:
      - type: remove-statements
        statement_ids:
          - "*"
      - type: set-public-block
        BlockPublicPolicy: true
        RestrictPublicBuckets: true
      - type: notify
        template: aws-basic_email.html
        subject: "Cloud Custodian: S3 Bucket Policy Allows Public Access - Remediated"
        to:
          - security@example.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # Policy 4: Alert when public access block is removed
  - name: s3-bucket-public-block-removed
    resource: s3
    description: Alert when S3 public access block settings are removed
    actions:
      - type: set-public-block
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      - type: notify
        template: aws-basic_email.html
        priority_header: "1"
        subject: "CRITICAL: S3 Bucket Public Access Block Removed - Restored"
        to:
          - security@example.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # Policy 5: Check public access block modifications
  - name: s3-bucket-public-block-check
    resource: s3
    description: Verify S3 public access block settings are properly configured
    filters:
      - type: check-public-block
        BlockPublicAcls: false
    actions:
      - type: set-public-block
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      - type: notify
        template: aws-basic_email.html
        subject: "Cloud Custodian: S3 Bucket Public Access Block Weak - Strengthened"
        to:
          - security@example.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue

  # Policy 8: Default check for any S3 event
  - name: s3-bucket-default-check
    resource: s3
    description: Default security check for S3 buckets
    filters:
      - or:
          - type: check-public-block
            BlockPublicAcls: false
          - type: value
            key: Acl
            value_type: swap
            op: in
            value:
              - public-read
              - public-read-write
    actions:
      - type: set-public-block
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      - type: notify
        template: aws-basic_email.html
        subject: "Cloud Custodian: S3 Bucket Security Issue Detected - Remediated"
        to:
          - security@example.com
        transport:
          type: sqs
          queue: https://sqs.us-east-1.amazonaws.com/172327596604/custodian-mailer-queue
