policies:
- name: ec2-public-instance-stepfunction-periodic
  resource: aws.ec2
  description: Periodic scan for existing EC2 instances with public IP addresses.
    Runs hourly to catch instances that may have been missed by real-time detection
    or had their networking configuration changed after launch.
  filters:
  - type: value
    key: State.Name
    value: running
  - or:
    - type: value
      key: PublicIpAddress
      value: not-null
    - type: value
      key: NetworkInterfaces[].Association.PublicIp
      value: not-null
  - type: value
    key: Tags[?Key == 'PublicInstanceApproved'] | length(@)
    value: 0
  - type: value
    key: Tags[?Key == 'SecurityFinding'] | length(@)
    value: 0
  actions:
  - type: invoke-sfn
    state-machine: arn:aws:states:{region}:{account}:stateMachine:EC2PublicInstanceRemediation
  - type: tag
    key: SecurityFinding
    value: PublicInstanceDetected
  - type: tag
    key: DetectionSource
    value: CloudCustodian-Periodic
  - type: tag
    key: DetectionTime
    value: '{now:%Y-%m-%d %H:%M:%S UTC}'
